<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NCAA Women's Volleyball ‚Äî Player Valuation Model</title>

<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0d13;--sf:#111520;--s2:#181d28;--s3:#1f2533;--bd:#272d3b;--tx:#e8eaed;--t2:#9ca3af;--t3:#5f6775;--ac:#f97316;--ac2:#fb923c;--ad:rgba(249,115,22,.12);--gn:#22c55e;--gd:rgba(34,197,94,.12);--bl:#3b82f6;--bld:rgba(59,130,246,.12);--pu:#a855f7;--pd:rgba(168,85,247,.12);--rd:#ef4444;--rdd:rgba(239,68,68,.12);--yw:#eab308;--yd:rgba(234,179,8,.12);--cy:#06b6d4;--cd:rgba(6,182,212,.12)}
*{margin:0;padding:0;box-sizing:border-box}body{background:var(--bg);color:var(--tx);font-family:'DM Sans',sans-serif;min-height:100vh}.mono{font-family:'Space Mono',monospace}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@keyframes fadeIn{from{opacity:0}to{opacity:1}}
button{font-family:inherit}

/* LOADING */
#US{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:2rem;position:relative}
#US::before{content:'';position:absolute;width:500px;height:500px;background:radial-gradient(circle,rgba(249,115,22,.05) 0%,transparent 70%);top:50%;left:50%;transform:translate(-50%,-50%)}
.uc{background:var(--sf);border:1px solid var(--bd);border-radius:20px;padding:3rem;max-width:540px;width:100%;text-align:center;position:relative;z-index:1;animation:fadeUp .4s ease-out}
.uc h1{font-size:1.5rem;font-weight:700;margin-bottom:.3rem}.uc h1 span{color:var(--ac)}.uc .sub{color:var(--t2);font-size:.85rem;margin-bottom:1.5rem}
.spinner{width:40px;height:40px;border:3px solid var(--bd);border-top-color:var(--ac);border-radius:50%;animation:spin .8s linear infinite;margin:1.5rem auto}
@keyframes spin{to{transform:rotate(360deg)}}
.load-status{font-size:.8rem;color:var(--t2);margin-top:.8rem}
.load-error{color:var(--rd);font-size:.78rem;margin-top:.8rem;display:none}
.chips{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin-bottom:1.5rem}
.chip{background:var(--s2);border:1px solid var(--bd);border-radius:8px;padding:.35rem .7rem;font-size:.72rem;color:var(--t2)}

/* TOPBAR */
#DB{display:none}
.topbar{background:var(--sf);border-bottom:1px solid var(--bd);padding:.7rem 1.5rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;flex-wrap:wrap;gap:.5rem}
.brand{display:flex;align-items:center;gap:.5rem;font-weight:700;font-size:.95rem}.brand span{color:var(--ac)}
.topbar-r{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
.pill{background:var(--s2);border:1px solid var(--bd);border-radius:7px;padding:.28rem .55rem;font-size:.66rem;color:var(--t2)}.pill b{color:var(--tx)}
.btn-s{background:var(--s2);border:1px solid var(--bd);color:var(--t2);padding:.28rem .55rem;border-radius:7px;font-size:.66rem;cursor:pointer;transition:all .15s}
.btn-s:hover{border-color:var(--ac);color:var(--ac)}

/* CONTROLS */
.cbar{background:var(--sf);border-bottom:1px solid var(--bd);padding:.6rem 1.5rem;display:flex;gap:.6rem;flex-wrap:wrap;align-items:flex-end}
.cg{display:flex;flex-direction:column;gap:.2rem}
.cg label{font-size:.56rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;font-weight:500}
.cg select,.cg input[type=text]{background:var(--s2);border:1px solid var(--bd);color:var(--tx);padding:.32rem .5rem;border-radius:7px;font-size:.76rem;font-family:inherit;min-width:120px;outline:none}
.cg select:focus,.cg input:focus{border-color:var(--ac)}
.cg input[type=text]{min-width:180px}
.ninput{background:var(--s2);border:1px solid var(--bd);color:var(--ac);padding:.32rem .5rem;border-radius:7px;font-size:.76rem;font-family:'Space Mono',monospace;width:90px;outline:none;text-align:center}
.ninput:focus{border-color:var(--ac)}

/* TABS */
.tbar{display:flex;gap:0;padding:0 1.5rem;background:var(--sf);border-bottom:1px solid var(--bd);overflow-x:auto}
.tbtn{padding:.55rem .9rem;font-size:.76rem;background:none;border:none;color:var(--t3);cursor:pointer;position:relative;font-weight:500;white-space:nowrap}
.tbtn:hover{color:var(--t2)}.tbtn.active{color:var(--ac)}
.tbtn.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--ac)}

/* CARDS */
.ogrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(165px,1fr));gap:.6rem;padding:.8rem 1.5rem}
.sc{background:var(--sf);border:1px solid var(--bd);border-radius:10px;padding:.8rem}
.sc .lb{font-size:.58rem;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:.3rem}
.sc .vl{font-family:'Space Mono',monospace;font-size:1.3rem;font-weight:700}
.sc .su{font-size:.62rem;color:var(--t3);margin-top:.1rem}
.sc.acc{border-color:var(--ac);background:var(--ad)}.sc.acc .vl{color:var(--ac)}

.main{padding:0 1.5rem 2rem}.tp{display:none}.tp.active{display:block}

/* TABLE */
.tw{background:var(--sf);border:1px solid var(--bd);border-radius:12px;overflow:hidden;margin-top:.7rem}
.thb{display:flex;align-items:center;justify-content:space-between;padding:.6rem 1rem;border-bottom:1px solid var(--bd);flex-wrap:wrap;gap:.4rem}
.thb h3{font-size:.85rem;font-weight:600}.thb .cnt{font-size:.66rem;color:var(--t3)}
.tscr{overflow-x:auto;max-height:65vh;overflow-y:auto}
table{width:100%;border-collapse:collapse;font-size:.73rem}
thead{position:sticky;top:0;z-index:10}
thead th{background:var(--s2);padding:.5rem .55rem;text-align:left;font-weight:600;font-size:.6rem;text-transform:uppercase;letter-spacing:.05em;color:var(--t2);white-space:nowrap;border-bottom:1px solid var(--bd);cursor:pointer;user-select:none}
thead th:hover{color:var(--ac)}thead th.sorted{color:var(--ac)}
tbody tr{border-bottom:1px solid var(--bd);transition:background .1s;cursor:pointer}
tbody tr:hover{background:var(--s2)}
tbody td{padding:.45rem .55rem;white-space:nowrap}
.pn{font-weight:600}.tn{color:var(--t2);font-size:.65rem}

/* BADGES */
.pb{display:inline-block;padding:.1rem .38rem;border-radius:5px;font-size:.6rem;font-weight:700;letter-spacing:.03em}
.pb.oh{background:var(--ad);color:var(--ac)}.pb.mb{background:var(--bld);color:var(--bl)}
.pb.s{background:var(--gd);color:var(--gn)}.pb.lds{background:var(--pd);color:var(--pu)}
.pb.opp{background:var(--rdd);color:var(--rd)}
.tb{display:inline-block;padding:.1rem .38rem;border-radius:5px;font-size:.6rem;font-weight:700}
.tb.elite{background:var(--yd);color:var(--yw)}.tb.starter{background:var(--gd);color:var(--gn)}
.tb.rotation{background:var(--bld);color:var(--bl)}.tb.bench{background:var(--pd);color:var(--pu)}
.tb.developmental{background:var(--s2);color:var(--t3)}
.vc{font-family:'Space Mono',monospace;font-weight:700;color:var(--gn);font-size:.73rem}
.sb{display:flex;align-items:center;gap:.3rem}.sb .bar{width:42px;height:4px;background:var(--s2);border-radius:2px;overflow:hidden}
.sb .bi{height:100%;border-radius:2px}.sb .sn{font-family:'Space Mono',monospace;font-size:.68rem;font-weight:700;min-width:22px}
.tag{display:inline-block;padding:.08rem .32rem;border-radius:4px;font-size:.56rem;font-weight:600;margin-right:.18rem;margin-bottom:.1rem;cursor:pointer;transition:opacity .12s}
.tag:hover{opacity:.8}

/* MODAL */
.mo{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.75);z-index:500;overflow-y:auto;padding:1.5rem}
.mo.show{display:flex;justify-content:center;align-items:flex-start;animation:fadeIn .15s}
.modal{background:var(--bg);border:1px solid var(--bd);border-radius:15px;width:100%;max-width:860px;margin:auto;position:relative;animation:fadeUp .25s ease-out}
.mcl{position:absolute;top:.7rem;right:.7rem;background:var(--s2);border:1px solid var(--bd);color:var(--t2);width:28px;height:28px;border-radius:7px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;justify-content:center;z-index:10}
.mcl:hover{border-color:var(--rd);color:var(--rd)}
.mhd{padding:1.3rem 1.3rem .7rem;border-bottom:1px solid var(--bd)}.mbd{padding:1.1rem 1.3rem 1.3rem}
.pgrid{display:grid;grid-template-columns:1fr 1fr;gap:.8rem}
.psec{background:var(--sf);border:1px solid var(--bd);border-radius:10px;padding:1rem}
.psec h4{font-size:.78rem;font-weight:600;margin-bottom:.6rem}.psec.full{grid-column:1/-1}

/* TOOLTIP */
.ttpop{display:none;position:fixed;z-index:600;background:var(--s2);border:1px solid var(--bd);border-radius:10px;padding:.9rem;max-width:310px;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:fadeUp .15s}
.ttpop.show{display:block}.ttpop h5{font-size:.8rem;font-weight:600;margin-bottom:.3rem}
.ttpop p{font-size:.73rem;color:var(--t2);line-height:1.5}.ttpop .ctt{position:absolute;top:.4rem;right:.4rem;background:none;border:none;color:var(--t3);cursor:pointer;font-size:.75rem}

/* WEIGHT TABLE */
.wtp{background:var(--sf);border:1px solid var(--bd);border-radius:12px;padding:1.1rem;margin-top:.7rem}
.wtp h3{font-size:.88rem;font-weight:600;margin-bottom:.2rem}
.wtp .wsub{font-size:.72rem;color:var(--t2);margin-bottom:.8rem}
.wtabs{display:flex;gap:0;margin-bottom:.8rem;border-bottom:1px solid var(--bd)}
.wtab{padding:.4rem .7rem;font-size:.72rem;background:none;border:none;color:var(--t3);cursor:pointer;font-weight:500;position:relative}
.wtab:hover{color:var(--t2)}.wtab.active{color:var(--ac)}.wtab.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--ac)}
.wtt{width:100%;border-collapse:collapse}
.wtt th{text-align:left;font-size:.6rem;text-transform:uppercase;letter-spacing:.05em;color:var(--t3);padding:.35rem .45rem;border-bottom:1px solid var(--bd);font-weight:600}
.wtt td{padding:.3rem .45rem;border-bottom:1px solid var(--bd);font-size:.75rem}
.wtt input[type=number]{background:var(--s3);border:1px solid var(--bd);color:var(--tx);padding:.25rem .35rem;border-radius:5px;font-family:'Space Mono',monospace;font-size:.72rem;width:58px;text-align:center;outline:none}
.wtt input:focus{border-color:var(--ac)}
.wft{display:flex;align-items:center;justify-content:space-between;margin-top:.7rem;padding-top:.7rem;border-top:1px solid var(--bd)}
.wft .wtot{font-size:.75rem;color:var(--t2)}.wft .wtot b{color:var(--tx)}
.wbtns{display:flex;gap:.3rem}
.btn-a{background:var(--ac);border:none;color:#fff;padding:.35rem .7rem;border-radius:7px;font-size:.7rem;cursor:pointer;font-weight:600}
.btn-a:hover{background:var(--ac2)}
.btn-r{background:var(--s2);border:1px solid var(--bd);color:var(--t2);padding:.35rem .7rem;border-radius:7px;font-size:.7rem;cursor:pointer}
.btn-r:hover{border-color:var(--ac);color:var(--ac)}

/* VALUATION SETTINGS */
.vsp{background:var(--sf);border:1px solid var(--bd);border-radius:12px;padding:1.1rem;margin-top:.7rem}
.vsp h3{font-size:.88rem;font-weight:600;margin-bottom:.2rem;display:flex;align-items:center;justify-content:space-between}
.vsp .vsub{font-size:.72rem;color:var(--t2);margin-bottom:.8rem}
.vsg{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:.6rem}
.vsg .vi{display:flex;flex-direction:column;gap:.2rem}
.vsg .vi label{font-size:.56rem;color:var(--t3);text-transform:uppercase;letter-spacing:.06em}
.vsg .vi input,.vsg .vi select{background:var(--s3);border:1px solid var(--bd);color:var(--tx);padding:.3rem .4rem;border-radius:6px;font-family:'Space Mono',monospace;font-size:.73rem;outline:none;width:100%}
.vsg .vi input:focus,.vsg .vi select:focus{border-color:var(--ac)}
.vsnote{font-size:.65rem;color:var(--t3);margin-top:.6rem;line-height:1.5;padding-top:.6rem;border-top:1px solid var(--bd)}

/* TEAM PROFILE */
.tprof{background:var(--sf);border:1px solid var(--bd);border-radius:12px;padding:1.1rem;margin-bottom:.8rem}
.tprof h3{font-size:.88rem;font-weight:600;margin-bottom:.8rem}
.tpr{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem}
.tpr .tpi{font-size:.75rem;width:18px;text-align:center}.tpr .tpl{font-size:.75rem;min-width:90px}
.tpr .tpb{flex:1;height:7px;background:var(--s3);border-radius:4px;overflow:hidden}
.tpr .tpf{height:100%;border-radius:4px;transition:width .4s}
.tpr .tpv{font-family:'Space Mono',monospace;font-size:.72rem;font-weight:700;min-width:32px;text-align:right}
.tptags{display:flex;flex-wrap:wrap;gap:.25rem;margin-top:.7rem;padding-top:.7rem;border-top:1px solid var(--bd)}

/* ROSTER CONFIG */
.rcfg{display:flex;gap:.7rem;flex-wrap:wrap;align-items:flex-end;margin-bottom:.8rem;padding:.8rem;background:var(--sf);border:1px solid var(--bd);border-radius:12px}
.alert{border-radius:9px;padding:.7rem .9rem;margin-bottom:.6rem;font-size:.78rem}
.alert-w{background:var(--yd);border:1px solid rgba(234,179,8,.2)}.alert-e{background:var(--rdd);border:1px solid rgba(239,68,68,.2)}
.alert-i{background:var(--bld);border:1px solid rgba(59,130,246,.2)}
.alert h4{font-size:.8rem;font-weight:600;margin-bottom:.15rem}.alert p{font-size:.72rem;opacity:.85}
.rec{display:flex;align-items:center;padding:.5rem .7rem;background:var(--sf);border:1px solid var(--bd);border-radius:8px;margin-bottom:.35rem;gap:.6rem;transition:border-color .12s}
.rec:hover{border-color:var(--ac)}.rec .ri{flex:1;min-width:0}.rec .rn{font-weight:600;font-size:.75rem}.rec .rt{font-size:.62rem;color:var(--t3)}
.btn-sw{background:var(--ad);border:1px solid rgba(249,115,22,.25);color:var(--ac);padding:.22rem .45rem;border-radius:5px;font-size:.62rem;cursor:pointer;font-weight:600;white-space:nowrap}
.btn-sw:hover{background:var(--ac);color:#fff}
.btn-ad{background:var(--gd);border:1px solid rgba(34,197,94,.25);color:var(--gn);padding:.22rem .45rem;border-radius:5px;font-size:.62rem;cursor:pointer;font-weight:600;white-space:nowrap}
.btn-ad:hover{background:var(--gn);color:#fff}
.btn-sel{background:var(--bld);border:1px solid rgba(59,130,246,.25);color:var(--bl);padding:.22rem .55rem;border-radius:5px;font-size:.62rem;cursor:pointer;font-weight:600}
.btn-sel:hover{background:var(--bl);color:#fff}

@media(max-width:768px){.pgrid{grid-template-columns:1fr}.cbar,.ogrid,.main,.topbar{padding-left:.7rem;padding-right:.7rem}}
</style>
</head>
<body>
<div id="US">
  <div class="uc"><h1>üèê NCAA <span>Volleyball</span></h1><p class="sub">Women's Player Valuation Model</p>
    <div class="chips"><div class="chip">2025 Season</div><div class="chip">Live Google Sheets</div><div class="chip">Per-Set Normalization</div></div>
    <div class="spinner" id="spinner"></div>
    <div class="load-status" id="load-status">Connecting to Google Sheets...</div>
    <div class="load-error" id="load-error"></div>
  </div>
</div>
<div id="DB">
  <div class="topbar"><div class="brand">üèê NCAA <span>Volleyball</span> <span style="color:var(--t3);font-weight:400;font-size:.65rem">v4</span></div><div class="topbar-r"><div class="pill"><b id="tpc">0</b> Players</div><div class="pill"><b id="ttc">0</b> Teams</div><button class="btn-s" onclick="location.reload()">‚Üª Refresh</button></div></div>
  <div class="cbar">
    <div class="cg"><label>Position</label><select id="fp"><option value="all">All Positions</option><option value="OH">OH</option><option value="MB">MB</option><option value="S">S</option><option value="L/DS">L/DS</option><option value="OPP">OPP</option></select></div>
    <div class="cg"><label>Tier</label><select id="ft"><option value="all">All</option><option value="Elite">Elite</option><option value="Starter">Starter</option><option value="Rotation">Rotation</option><option value="Bench">Bench</option><option value="Developmental">Dev</option></select></div>
    <div class="cg"><label>Search</label><input type="text" id="fs" placeholder="Player or team..."></div>
  </div>
  <div class="tbar">
    <button class="tbtn active" data-tab="players">Players</button>
    <button class="tbtn" data-tab="positions">Positions</button>
    <button class="tbtn" data-tab="roster">Roster Builder</button>
    <button class="tbtn" data-tab="weights">‚öô Weights</button>
    <button class="tbtn" data-tab="valuation">üí∞ Valuation</button>
    <button class="tbtn" data-tab="methodology">Methodology</button>
  </div>
  <div id="ostats" class="ogrid"></div>
  <div class="main">
    <div class="tp active" id="p-players"><div class="tw"><div class="thb"><h3>All Players</h3><span class="cnt" id="plc"></span><div style="display:flex;gap:.3rem;align-items:center" id="pgnav"></div></div><div class="tscr" id="plt"></div></div></div>
    <div class="tp" id="p-positions"><div id="pgd"></div></div>
    <div class="tp" id="p-roster"><div id="rz"></div></div>
    <div class="tp" id="p-weights"><div id="wz"></div></div>
    <div class="tp" id="p-valuation"><div id="vz"></div></div>
    <div class="tp" id="p-methodology"><div id="mz"></div></div>
  </div>
</div>
<div class="mo" id="pm"><div class="modal"><button class="mcl" onclick="closeM()">‚úï</button><div class="mhd" id="mh"></div><div class="mbd" id="mb"></div></div></div>
<div class="ttpop" id="ttp"><button class="ctt" onclick="closeTT()">‚úï</button><h5 id="ttt"></h5><p id="ttb"></p></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function nP(p){if(!p)return'?';const u=p.trim().toUpperCase();if(u==='OH')return'OH';if(u==='MB'||u==='MH')return'MB';if(u==='S')return'S';if(u==='L'||u==='L/DS'||u==='DS')return'L/DS';if(u==='OPP'||u==='RS')return'OPP';return'?'}
const PN={'OH':'Outside Hitter','MB':'Middle Blocker','S':'Setter','L/DS':'Libero / DS','OPP':'Opposite Hitter'};
const PC={'OH':'var(--ac)','MB':'var(--bl)','S':'var(--gn)','L/DS':'var(--pu)','OPP':'var(--rd)'};

const SI={kills_per_set:{n:'Kills/Set',dir:'up',d:'A kill = successful attack scoring a point. Higher = more productive scorer. The bread-and-butter for attackers (OH, OPP, MB).'},hit_pct:{n:'Hit %',dir:'up',d:'(Kills ‚àí Errors) / Attempts. Measures attacking efficiency. Elite = .300+. Like batting average in baseball.'},digs_per_set:{n:'Digs/Set',dir:'up',d:'Successfully passing a hard-driven attack. Best proxy for serve-receive passing ability ‚Äî the two skills are highly correlated. Critical for L/DS, important for OH/OPP.'},aces_per_set:{n:'Aces/Set',dir:'up',d:'Serves that directly score points. Higher = more dangerous server who pressures opponents from the service line.'},blk_per_set:{n:'Blocks/Set',dir:'up',d:'Deflecting/stopping attacks at the net. THE defining stat for middle blockers. Great blockers change how opponents attack.'},atk_err_rate:{n:'Atk Err Rate',dir:'down',d:'% of attacks resulting in errors. LOWER is better ‚Äî high error rate = giving away free points. Penalized.'},serv_err_rate:{n:'Serv Err Rate',dir:'down',d:'Service errors per set. LOWER is better. Aggressive serving creates aces, but too many errors negate value. Penalized.'},pts_per_set:{n:'Points/Set',dir:'up',d:'Total points per set (kills + aces + solo blocks). Bottom-line scoring output.'},consistency:{n:'Consistency',dir:'up',d:'Sets played relative to full season (~110 sets). Coaches keep best players on floor ‚Äî a trust/durability metric.'},assists_per_set:{n:'Assists/Set',dir:'up',d:'Sets/passes leading directly to kills. THE key setter stat ‚Äî volleyball equivalent of basketball assists. Elite setters: 10+/set.'},bh_err_rate:{n:'BH Err Rate',dir:'down',d:'Ball-handling errors/set (double contacts, lifts). LOWER is better. Critical for setters ‚Äî high BH errors disrupt offense. Penalized.'}};

const TI={
  'Ironwoman':'100+ sets played this season ‚Äî incredible durability. In a typical 30-match season (~3.5 sets/match), this player was on court for nearly every point.',
  'Point Machine':'4.5+ points per set ‚Äî elite-level scorer contributing heavily through kills, aces, and/or blocks.',
  'Ace Server':'0.35+ aces per set ‚Äî roughly one ace every 3 sets. Elite serving rate that directly pressures opposing passing.',
  'Clean Server':'Very low service error rate. This player rarely gives away free points on serve.',
  'Elite Scorer':'3.5+ kills/set (OH) or 3.0+ (OPP). Among the top offensive producers at their position ‚Äî the go-to option.',
  '6-Rotation Star':'OH excelling in BOTH offense (2.5+ K/S) AND defense (2.5+ D/S). Plays all 6 rotations effectively ‚Äî one of the most valuable player types.',
  'Floor General':'3.0+ digs/set ‚Äî anchors the defense and keeps rallies alive. Named for their ability to read the game and position perfectly. For setters: 8.0+ assists/set running an efficient offense.',
  'Efficient Hitter':'Hitting .300+ (OH/OPP) or .350+ (MB). Converts a high % of attacks into kills with minimal errors.',
  'Error Prone':'Attack error rate above 20%. Has offensive tools but gives back too many points on unforced errors.',
  'Defensive Specialist':'High digs/set but low hitting efficiency ‚Äî primary value comes from back-row passing and defense.',
  'Wall':'MB averaging 1.0+ blocks/set. Elite shot-blocker who changes how opponents attack.',
  'Elite Efficiency':'MB hitting .400+. Exceptional attack conversion rate ‚Äî rarely makes errors on quick-tempo swings.',
  'Dual Threat':'MB with strong kills AND blocks ‚Äî dangerous both offensively and defensively at the net.',
  'Undersized':'Low blocking output for a middle blocker ‚Äî may indicate height/reach disadvantage.',
  'Maestro':'Setter with 10.0+ assists/set. Running the offense at the highest level ‚Äî orchestrates the entire attack.',
  'Defensive Setter':'Setter who also digs 2.0+ per set. Contributing defensively while running offense = exceptionally versatile.',
  'Blocking Setter':'Setter with 0.4+ blocks/set. Contributing at the net is a bonus most setters can\'t offer.',
  'Clean Hands':'Near-zero ball handling errors ‚Äî elite hand technique. Rarely called for doubles or lifts.',
  'Loose Hands':'High BH error rate. Needs improved technique to run a clean offense.',
  'Elite Passer':'L/DS averaging 4.5+ digs/set ‚Äî gold standard for back-row defense. Almost certainly an elite serve-receive passer.',
  'Lockdown Defender':'L/DS with 3.5+ digs/set. Strong defensive presence keeping the ball alive.',
  'Playmaker Libero':'Libero with 1.0+ assists/set ‚Äî makes smart overhand sets, adding offensive dimension.',
  'Every-Set Player':'Libero playing 110+ sets ‚Äî coaches trust this player for virtually every rally.',
  'Scoring Opposite':'3.0+ kills/set from right side. Legitimate offensive weapon, not just a blocking specialist.',
  'Blocking Opposite':'OPP with 0.8+ blocks/set. Strong net presence on right side, slowing opposing OHs.',
  'Complete Player':'OPP who scores (2.5+ K/S), blocks (0.7+ B/S), AND digs (1.5+ D/S). Most well-rounded opposite ‚Äî rare and extremely valuable.'
};

// DEFAULT WEIGHTS {w: weight 0-50, min, max, dir}
// WEIGHTS: Each position sums to EXACTLY 100. Min/Max from real NCAA D1 2025 data (p10/p95).
const DW={
  'OH':{kills_per_set:{w:24,min:0.43,max:3.88,dir:'up'},hit_pct:{w:17,min:0.04,max:0.28,dir:'up'},digs_per_set:{w:17,min:0.33,max:2.69,dir:'up'},aces_per_set:{w:9,min:0.00,max:0.36,dir:'up'},blk_per_set:{w:5,min:0.05,max:0.68,dir:'up'},atk_err_rate:{w:8,min:0.12,max:0.25,dir:'down'},serv_err_rate:{w:5,min:0.00,max:0.53,dir:'down'},pts_per_set:{w:9,min:0.61,max:4.33,dir:'up'},consistency:{w:6,min:0.25,max:1.00,dir:'up'}},
  'MB':{kills_per_set:{w:14,min:0.66,max:2.45,dir:'up'},hit_pct:{w:24,min:0.13,max:0.39,dir:'up'},digs_per_set:{w:3,min:0.13,max:0.70,dir:'up'},aces_per_set:{w:6,min:0.00,max:0.29,dir:'up'},blk_per_set:{w:24,min:0.45,max:1.29,dir:'up'},atk_err_rate:{w:6,min:0.10,max:0.23,dir:'down'},serv_err_rate:{w:4,min:0.00,max:0.42,dir:'down'},pts_per_set:{w:12,min:1.08,max:3.14,dir:'up'},consistency:{w:7,min:0.26,max:1.00,dir:'up'}},
  'S':{kills_per_set:{w:2,min:0.01,max:0.94,dir:'up'},hit_pct:{w:4,min:0.00,max:0.37,dir:'up'},digs_per_set:{w:14,min:0.77,max:2.65,dir:'up'},aces_per_set:{w:11,min:0.06,max:0.38,dir:'up'},blk_per_set:{w:5,min:0.00,max:0.57,dir:'up'},atk_err_rate:{w:2,min:0.00,max:0.25,dir:'down'},serv_err_rate:{w:5,min:0.10,max:0.50,dir:'down'},assists_per_set:{w:38,min:1.19,max:10.15,dir:'up'},bh_err_rate:{w:7,min:0.00,max:0.04,dir:'down'},pts_per_set:{w:3,min:0.14,max:1.45,dir:'up'},consistency:{w:9,min:0.27,max:1.00,dir:'up'}},
  'L/DS':{kills_per_set:{w:1,min:0.00,max:0.06,dir:'up'},hit_pct:{w:1,min:-0.17,max:0.50,dir:'up'},digs_per_set:{w:44,min:0.51,max:4.42,dir:'up'},aces_per_set:{w:16,min:0.03,max:0.34,dir:'up'},blk_per_set:{w:0,min:0.00,max:0.01,dir:'up'},atk_err_rate:{w:1,min:0.00,max:0.33,dir:'down'},serv_err_rate:{w:8,min:0.07,max:0.45,dir:'down'},assists_per_set:{w:11,min:0.06,max:1.21,dir:'up'},pts_per_set:{w:2,min:0.04,max:0.38,dir:'up'},consistency:{w:16,min:0.30,max:1.00,dir:'up'}},
  'OPP':{kills_per_set:{w:21,min:0.73,max:3.29,dir:'up'},hit_pct:{w:17,min:0.06,max:0.31,dir:'up'},digs_per_set:{w:12,min:0.23,max:1.99,dir:'up'},aces_per_set:{w:9,min:0.00,max:0.31,dir:'up'},blk_per_set:{w:14,min:0.22,max:0.88,dir:'up'},atk_err_rate:{w:7,min:0.12,max:0.25,dir:'down'},serv_err_rate:{w:5,min:0.00,max:0.42,dir:'down'},pts_per_set:{w:9,min:0.91,max:3.84,dir:'up'},consistency:{w:6,min:0.20,max:1.00,dir:'up'}}};
let W=JSON.parse(JSON.stringify(DW));

// VALUATION SETTINGS
let VS={avgPay:25000,minPay:3000,maxPay:85000,starValue:70000,starPctile:.95,setsAdj:'on',setsPctile:.90};
const VS_DEF={...VS};

function gm(p){const s=Math.max(p.Sets||1,1),a=Math.max(p.Atk||1,1);return{kills_per_set:(p.Kills||0)/s,hit_pct:parseFloat(p['Hit %'])||0,digs_per_set:(p.Digs||0)/s,aces_per_set:(p.Aces||0)/s,blk_per_set:(p['Total Blk']||0)/s,atk_err_rate:(p['Atk Err']||0)/a,serv_err_rate:(p['Serv Err']||0)/s,assists_per_set:(p.Assists||0)/s,bh_err_rate:(p['BH Err']||0)/s,pts_per_set:(p.PTS||0)/s,consistency:Math.min(s/110,1)}}
function gPc(v,arr,inv){if(!arr||!arr.length)return .5;let c=0;for(const x of arr)if(v>=x)c++;let p=c/arr.length;if(inv)p=1-p;return Math.max(0,Math.min(1,p))}
function bPc(pl){const g={};for(const p of pl){const pos=p._np;if(!W[pos])continue;const m=gm(p);for(const st of Object.keys(W[pos])){const k=`${pos}_${st}`;if(!g[k])g[k]=[];g[k].push(m[st]||0)}}for(const k of Object.keys(g))g[k].sort((a,b)=>a-b);return g}

function scoreP(p,pct){const w=W[p._np];if(!w)return 0;const m=gm(p);let sc=0;for(const[st,cfg]of Object.entries(w)){const arr=pct[`${p._np}_${st}`];if(!arr)continue;sc+=cfg.w/100*gPc(m[st]||0,arr,cfg.dir==='down')}return Math.round(sc*100)}

function gSP(p,pct){const w=W[p._np];if(!w)return{};const m=gm(p);const r={};for(const[st,cfg]of Object.entries(w)){const arr=pct[`${p._np}_${st}`];if(!arr)continue;r[st]={value:m[st]||0,pctile:Math.round(gPc(m[st]||0,arr,cfg.dir==='down')*100),weight:cfg.w,dir:cfg.dir}}return r}

function gTier(s){if(s>=82)return'Elite';if(s>=65)return'Starter';if(s>=45)return'Rotation';if(s>=28)return'Bench';return'Developmental'}

// VALUATION with sets adjustment
function gVal(p){
  const rawScore=p._score/100;
  // Sets adjustment: sqrt(min(1, sets/sets_p90))
  let adj=1;
  if(VS.setsAdj==='on'){
    const setsThresh=ALL.length?quantile(ALL.map(x=>x.Sets),VS.setsPctile):100;
    adj=Math.sqrt(Math.min(1,(p.Sets||1)/setsThresh));
  }
  const adjustedScore=rawScore*adj;
  // Exponential curve anchored at avgPay
  // At starPctile score (e.g. .95), value = avgPay + starValue
  // val = minPay + (maxPay - minPay) * (adjustedScore ^ exponent)
  // Solve exponent so that at starPctile, val ~ avgPay + starValue (capped at maxPay)
  const exponent=2.2;
  let val=VS.minPay+(VS.maxPay-VS.minPay)*Math.pow(adjustedScore,exponent);
  val=Math.max(VS.minPay,Math.min(VS.maxPay,val));
  return Math.round(val/100)*100;
}

function quantile(arr,q){const s=[...arr].sort((a,b)=>a-b);const i=Math.floor(s.length*q);return s[Math.min(i,s.length-1)]}

function gTags(p){const tags=[];const s=Math.max(p.Sets||1,1);const kps=(p.Kills||0)/s,dps=(p.Digs||0)/s,aps=(p.Assists||0)/s,bps=(p['Total Blk']||0)/s,acps=(p.Aces||0)/s,hp=parseFloat(p['Hit %'])||0,pps=(p.PTS||0)/s,aerr=(p['Atk Err']||0)/Math.max(p.Atk||1,1);
  if(p.Sets>=100)tags.push({t:'Ironwoman',c:'var(--yw)',bg:'var(--yd)'});
  if(pps>=4.5)tags.push({t:'Point Machine',c:'var(--ac)',bg:'var(--ad)'});
  if(acps>=0.35)tags.push({t:'Ace Server',c:'var(--cy)',bg:'var(--cd)'});
  if((p['Serv Err']||0)/s<0.08&&p.Sets>=60)tags.push({t:'Clean Server',c:'var(--gn)',bg:'var(--gd)'});
  const pos=p._np;
  if(pos==='OH'){if(kps>=3.5)tags.push({t:'Elite Scorer',c:'var(--ac)',bg:'var(--ad)'});if(kps>=2.5&&dps>=2.5)tags.push({t:'6-Rotation Star',c:'var(--yw)',bg:'var(--yd)'});if(dps>=3.0)tags.push({t:'Floor General',c:'var(--pu)',bg:'var(--pd)'});if(hp>=.300)tags.push({t:'Efficient Hitter',c:'var(--gn)',bg:'var(--gd)'});if(aerr>=.20)tags.push({t:'Error Prone',c:'var(--rd)',bg:'var(--rdd)'})}
  if(pos==='MB'){if(bps>=1.0)tags.push({t:'Wall',c:'var(--bl)',bg:'var(--bld)'});if(hp>=.400)tags.push({t:'Elite Efficiency',c:'var(--yw)',bg:'var(--yd)'});else if(hp>=.350)tags.push({t:'Efficient Hitter',c:'var(--gn)',bg:'var(--gd)'});if(kps>=2.0&&bps>=0.8)tags.push({t:'Dual Threat',c:'var(--ac)',bg:'var(--ad)'});if(bps<0.3&&p.Sets>=60)tags.push({t:'Undersized',c:'var(--rd)',bg:'var(--rdd)'})}
  if(pos==='S'){if(aps>=10.0)tags.push({t:'Maestro',c:'var(--gn)',bg:'var(--gd)'});else if(aps>=8.0)tags.push({t:'Floor General',c:'var(--gn)',bg:'var(--gd)'});if(dps>=2.0)tags.push({t:'Defensive Setter',c:'var(--pu)',bg:'var(--pd)'});if(bps>=0.4)tags.push({t:'Blocking Setter',c:'var(--bl)',bg:'var(--bld)'});if((p['BH Err']||0)/s<=0.002&&p.Sets>=60)tags.push({t:'Clean Hands',c:'var(--cy)',bg:'var(--cd)'});if((p['BH Err']||0)/s>=0.05)tags.push({t:'Loose Hands',c:'var(--rd)',bg:'var(--rdd)'})}
  if(pos==='L/DS'){if(dps>=4.5)tags.push({t:'Elite Passer',c:'var(--yw)',bg:'var(--yd)'});else if(dps>=3.5)tags.push({t:'Lockdown Defender',c:'var(--pu)',bg:'var(--pd)'});if(aps>=1.0)tags.push({t:'Playmaker Libero',c:'var(--gn)',bg:'var(--gd)'});if(acps>=0.25)tags.push({t:'Ace Server',c:'var(--cy)',bg:'var(--cd)'});if(p.Sets>=110)tags.push({t:'Every-Set Player',c:'var(--yw)',bg:'var(--yd)'})}
  if(pos==='OPP'){if(kps>=3.0)tags.push({t:'Scoring Opposite',c:'var(--ac)',bg:'var(--ad)'});if(bps>=0.8)tags.push({t:'Blocking Opposite',c:'var(--bl)',bg:'var(--bld)'});if(kps>=2.5&&bps>=0.7&&dps>=1.5)tags.push({t:'Complete Player',c:'var(--yw)',bg:'var(--yd)'});if(hp>=.300)tags.push({t:'Efficient Hitter',c:'var(--gn)',bg:'var(--gd)'})}
  return tags}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ALL=[],FILT=[],ROST=[],PCT={},HIST={};let SC='score',SD='desc';let RSIZE=14,TBUDGET=250000,PBUDGET=85000;

function processData(raw){
  // Build history map: player name -> array of all season rows (all years)
  HIST={};
  for(const r of raw){
    const name=r.Player;if(!name)continue;
    if(!HIST[name])HIST[name]=[];
    const row={...r};
    row.Season=parseFloat(row.Season)||0;
    row['Hit %']=parseFloat(row['Hit %'])||0;
    row.Sets=parseFloat(row.Sets)||0;row.Matches=parseFloat(row.Matches)||0;
    row.Kills=parseFloat(row.Kills)||0;row['Atk Err']=parseFloat(row['Atk Err'])||0;
    row.Atk=parseFloat(row.Atk)||0;row.Assists=parseFloat(row.Assists)||0;
    row.Aces=parseFloat(row.Aces)||0;row['Serv Err']=parseFloat(row['Serv Err'])||0;
    row.Digs=parseFloat(row.Digs)||0;row['Total Blk']=parseFloat(row['Total Blk'])||0;
    row['BH Err']=parseFloat(row['BH Err'])||0;row.PTS=parseFloat(row.PTS)||0;
    row._np=nP(row.Pos);
    HIST[name].push(row);
  }
  // Sort each player's history by season
  for(const name of Object.keys(HIST))HIST[name].sort((a,b)=>a.Season-b.Season);

  // Filter to 2025 only for scoring/ranking
  const pl=raw.filter(r=>(parseFloat(r.Season)||0)===2025).map((r,i)=>{r._np=nP(r.Pos);r._id=i;r['Hit %']=parseFloat(r['Hit %'])||0;r.Sets=parseFloat(r.Sets)||0;r.Matches=parseFloat(r.Matches)||0;r.Kills=parseFloat(r.Kills)||0;r['Atk Err']=parseFloat(r['Atk Err'])||0;r.Atk=parseFloat(r.Atk)||0;r.Assists=parseFloat(r.Assists)||0;r.Aces=parseFloat(r.Aces)||0;r['Serv Err']=parseFloat(r['Serv Err'])||0;r.Digs=parseFloat(r.Digs)||0;r['Total Blk']=parseFloat(r['Total Blk'])||0;r['BH Err']=parseFloat(r['BH Err'])||0;r.PTS=parseFloat(r.PTS)||0;return r}).filter(p=>W[p._np]&&p.Sets>=15);
  const seen={},ded=[];for(const p of pl){if(seen[p.Player]){if(p.Sets>(seen[p.Player].Sets||0)){ded[ded.indexOf(seen[p.Player])]=p;seen[p.Player]=p}}else{seen[p.Player]=p;ded.push(p)}}
  return ded}

function calcAll(){PCT=bPc(ALL);for(const p of ALL){p._score=scoreP(p,PCT);p._tier=gTier(p._score);p._val=gVal(p);p._tags=gTags(p);const s=Math.max(p.Sets||1,1);p._kps=((p.Kills||0)/s).toFixed(2);p._dps=((p.Digs||0)/s).toFixed(2);p._aps=((p.Assists||0)/s).toFixed(2);p._bps=((p['Total Blk']||0)/s).toFixed(2);p._acps=((p.Aces||0)/s).toFixed(2);p._pps=((p.PTS||0)/s).toFixed(2)}}
function recalc(){calcAll();applyF()}

// GOOGLE SHEETS CONFIG
const SHEET_ID='1GW4mO-9XPES8eovL4LoiGCrgwl8XlPdxLBc7HKkJclw';
const API_KEY='AIzaSyBUb41lyf4Lgh-NUAWwLiOMLdKBFZ6SwyY';
const SHEET_NAME='Sheet1';

async function fetchSheet(){
  const status=document.getElementById('load-status');
  const errEl=document.getElementById('load-error');
  try{
    status.textContent='Fetching data from Google Sheets...';
    const url=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(SHEET_NAME)}?key=${API_KEY}`;
    const resp=await fetch(url);
    if(!resp.ok){
      // Try common sheet names
      for(const name of ['Master','Data','2025','Sheet 1']){
        const url2=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(name)}?key=${API_KEY}`;
        const resp2=await fetch(url2);
        if(resp2.ok){const data=await resp2.json();return parseSheetData(data,status)}
      }
      throw new Error(`Sheet API returned ${resp.status}. Check that the spreadsheet is shared publicly.`);
    }
    const data=await resp.json();
    parseSheetData(data,status);
  }catch(err){
    document.getElementById('spinner').style.display='none';
    status.style.display='none';
    errEl.style.display='block';
    errEl.textContent='Error: '+err.message;
  }
}

function parseSheetData(data,status){
  status.textContent='Parsing rows...';
  const rows=data.values;
  if(!rows||rows.length<2)throw new Error('No data found in sheet');
  const headers=rows[0];
  const raw=[];
  // Map headers to expected column names
  const hMap={};
  const expected=['Season','Player','Pos','Team','Sets','Matches','Kills','Atk Err','Atk','Hit %','Assists','Aces','Serv Err','Digs','Total Blk','Solo Blk','Blk Ast','Blk Err','BH Err','PTS'];
  headers.forEach((h,i)=>{
    const clean=h.trim();
    if(expected.includes(clean))hMap[clean]=i;
    // Fuzzy match
    else if(clean.toLowerCase().includes('hit'))hMap['Hit %']=i;
    else if(clean.toLowerCase()==='total blk'||clean.toLowerCase()==='total blocks')hMap['Total Blk']=i;
    else if(clean.toLowerCase()==='atk err'||clean.toLowerCase()==='attack errors')hMap['Atk Err']=i;
    else if(clean.toLowerCase()==='serv err'||clean.toLowerCase()==='service errors')hMap['Serv Err']=i;
    else if(clean.toLowerCase()==='bh err'||clean.toLowerCase()==='ball handling errors')hMap['BH Err']=i;
    else if(clean.toLowerCase()==='blk err'||clean.toLowerCase()==='block errors')hMap['Blk Err']=i;
    else if(clean.toLowerCase()==='blk ast'||clean.toLowerCase()==='block assists')hMap['Blk Ast']=i;
    else if(clean.toLowerCase()==='solo blk'||clean.toLowerCase()==='solo blocks')hMap['Solo Blk']=i;
  });
  
  for(let i=1;i<rows.length;i++){
    const r=rows[i];
    const obj={};
    for(const[key,idx]of Object.entries(hMap)){
      let val=r[idx];
      if(val===undefined||val===null||val==='')val=key==='Player'||key==='Team'||key==='Pos'?'':'0';
      // Convert numeric fields
      if(!['Player','Team','Pos'].includes(key)){
        val=parseFloat(String(val).replace(/,/g,''))||0;
      }
      obj[key]=val;
    }
    if(obj.Player&&obj.Pos)raw.push(obj);
  }
  
  status.textContent=`Processing ${raw.length} rows...`;
  setTimeout(()=>{
    ALL=processData(raw);calcAll();FILT=[...ALL];
    status.textContent='Done!';
    setTimeout(()=>{
      document.getElementById('US').style.display='none';
      document.getElementById('DB').style.display='block';
      initD();
    },300);
  },50);
}

// Auto-load on page ready
document.addEventListener('DOMContentLoaded',fetchSheet);

// DASHBOARD
function initD(){document.getElementById('tpc').textContent=ALL.length.toLocaleString();document.getElementById('ttc').textContent=new Set(ALL.map(p=>p.Team)).size;
  document.getElementById('fp').addEventListener('change',applyF);document.getElementById('ft').addEventListener('change',applyF);document.getElementById('fs').addEventListener('input',applyF);
  document.querySelectorAll('.tbtn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.tbtn').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.tp').forEach(x=>x.classList.remove('active'));b.classList.add('active');document.getElementById('p-'+b.dataset.tab).classList.add('active')}));
  applyF();renderW();renderVS();renderMeth()}

function applyF(){const pos=document.getElementById('fp').value,tier=document.getElementById('ft').value,search=document.getElementById('fs').value.toLowerCase().trim();
  FILT=ALL.filter(p=>{if(pos!=='all'&&p._np!==pos)return false;if(tier!=='all'&&p._tier!==tier)return false;if(search&&!p.Player.toLowerCase().includes(search)&&!p.Team.toLowerCase().includes(search))return false;return true});PG=0;sortD();renderAll()}
function sortD(){FILT.sort((a,b)=>{let av,bv;switch(SC){case'score':av=a._score;bv=b._score;break;case'val':av=a._val;bv=b._val;break;case'kills':av=+a._kps;bv=+b._kps;break;case'digs':av=+a._dps;bv=+b._dps;break;case'assists':av=+a._aps;bv=+b._aps;break;case'blocks':av=+a._bps;bv=+b._bps;break;case'aces':av=+a._acps;bv=+b._acps;break;case'hitpct':av=a['Hit %'];bv=b['Hit %'];break;case'pts':av=+a._pps;bv=+b._pps;break;case'player':av=a.Player;bv=b.Player;break;default:av=a._score;bv=b._score}if(SC==='player')return SD==='asc'?av.localeCompare(bv):bv.localeCompare(av);return SD==='asc'?av-bv:bv-av})}
function setS(c){if(SC===c)SD=SD==='desc'?'asc':'desc';else{SC=c;SD='desc'}PG=0;sortD();renderAll()}

// RENDER HELPERS
function pbH(pos){const c=pos.toLowerCase().replace('/','');return `<span class="pb ${c}">${pos}</span>`}
const TIER_INFO={
  'Elite':'Score 82‚Äì100. Top ~5% of players at their position. These are All-Conference / All-American caliber players who dominate in their key stats. They\'re the players who change games and are worth premium NIL investment.',
  'Starter':'Score 65‚Äì81. Above-average players who are reliable starters on most rosters. They perform well across their key stats and are consistent contributors. Solid NIL value ‚Äî they start and produce.',
  'Rotation':'Score 45‚Äì64. Average-range players who contribute in a rotation role. They may start on some teams or come in for specific situations. Good developmental upside ‚Äî could become starters with improvement in 1‚Äì2 areas.',
  'Bench':'Score 28‚Äì44. Below-average production relative to position peers. These players see limited court time or are early in development. Low NIL value currently but may have potential if they improve.',
  'Developmental':'Score 0‚Äì27. Minimal statistical production ‚Äî either very limited playing time, freshmen getting their first reps, or players whose skills haven\'t translated to stats yet. Lowest NIL tier but could be future contributors.'
};
function tbH(t){return `<span class="tb ${t.toLowerCase()}" style="cursor:pointer" onclick="event.stopPropagation();showTierTT(this,'${t}')">${t}</span>`}
function showTierTT(el,tier){const tt=document.getElementById('ttp');const r=el.getBoundingClientRect();document.getElementById('ttt').textContent=tier+' Tier';document.getElementById('ttb').textContent=TIER_INFO[tier]||'No info.';tt.style.top=Math.min(r.bottom+6,window.innerHeight-180)+'px';tt.style.left=Math.min(r.left,window.innerWidth-320)+'px';tt.classList.add('show')}
function sBarH(s){const p=Math.min(s,100);let c='var(--t3)';if(s>=82)c='var(--yw)';else if(s>=65)c='var(--gn)';else if(s>=45)c='var(--bl)';else if(s>=28)c='var(--pu)';return `<div class="sb"><span class="sn" style="color:${c}">${s}</span><div class="bar"><div class="bi" style="width:${p}%;background:${c}"></div></div></div>`}
function thSH(l,c){const a=SC===c;return `<th class="${a?'sorted':''}" onclick="setS('${c}')">${l}${a?(SD==='desc'?' ‚ñº':' ‚ñ≤'):''}</th>`}
function tagHH(tags,click){return tags.map(t=>`<span class="tag" style="background:${t.bg};color:${t.c}" ${click?`onclick="event.stopPropagation();showTT(this,'${t.t.replace(/'/g,"\\'")}')"`:``}>${t.t}</span>`).join('')}

function buildTbl(pl,mode,offset){
  const o=offset||0;
  let h=`<table><thead><tr><th>#</th>${thSH('Player','player')}<th>Pos</th>${thSH('Score','score')}<th>Tier</th>${thSH('Value','val')}<th>Tags</th>${thSH('K/S','kills')}${thSH('Hit%','hitpct')}${thSH('D/S','digs')}${thSH('A/S','assists')}${thSH('B/S','blocks')}${thSH('Ace/S','aces')}<th>Sets</th>${mode==='add'?'<th></th>':''}</tr></thead><tbody>`;
  pl.forEach((p,i)=>{const inR=ROST.some(r=>r._id===p._id);
    h+=`<tr onclick="openP(${p._id})"><td class="mono" style="color:var(--t3);font-size:.62rem">${o+i+1}</td><td><span class="pn">${p.Player}</span><br><span class="tn">${p.Team}</span></td><td>${pbH(p._np)}</td><td>${sBarH(p._score)}</td><td>${tbH(p._tier)}</td><td class="vc">$${p._val.toLocaleString()}</td><td style="max-width:160px;white-space:normal">${tagHH(p._tags.slice(0,3),false)}</td><td class="mono" style="font-size:.68rem">${p._kps}</td><td class="mono" style="font-size:.68rem">${(p['Hit %']||0).toFixed(3)}</td><td class="mono" style="font-size:.68rem">${p._dps}</td><td class="mono" style="font-size:.68rem">${p._aps}</td><td class="mono" style="font-size:.68rem">${p._bps}</td><td class="mono" style="font-size:.68rem">${p._acps}</td><td class="mono" style="font-size:.68rem;color:var(--t3)">${p.Sets}</td>${mode==='add'?`<td onclick="event.stopPropagation()">${inR?'<span style="color:var(--gn);font-size:.58rem">‚úì</span>':`<button class="btn-ad" onclick="addR(${p._id})">+</button>`}</td>`:''}</tr>`});
  return h+'</tbody></table>'}

function renderAll(){renderStats();renderPlayers();renderPos();renderRost()}
function renderStats(){const c=document.getElementById('ostats');const avg=FILT.length?(FILT.reduce((s,p)=>s+p._score,0)/FILT.length).toFixed(1):0;const avgV=FILT.length?Math.round(FILT.reduce((s,p)=>s+p._val,0)/FILT.length):0;const el=FILT.filter(p=>p._tier==='Elite').length;const top=FILT.length?FILT.reduce((a,b)=>a._score>b._score?a:b):null;const spent=ROST.reduce((s,p)=>s+p._val,0);
  c.innerHTML=`<div class="sc"><div class="lb">Players</div><div class="vl mono">${FILT.length.toLocaleString()}</div></div><div class="sc"><div class="lb">Avg Score</div><div class="vl mono">${avg}</div></div><div class="sc"><div class="lb">Avg Value</div><div class="vl mono">$${avgV.toLocaleString()}</div></div><div class="sc"><div class="lb">Elite</div><div class="vl mono" style="color:var(--yw)">${el}</div></div><div class="sc"><div class="lb">#1 Player</div><div class="vl" style="font-size:.82rem;font-family:'DM Sans'">${top?top.Player:'‚Äî'}</div><div class="su">${top?top.Team+' ¬∑ '+top._score:''}</div></div><div class="sc acc"><div class="lb">Budget Left</div><div class="vl mono">$${(TBUDGET-spent).toLocaleString()}</div><div class="su">${ROST.length}/${RSIZE}</div></div>`}
let PG=0,PG_SIZE=200;
function renderPlayers(){
  const total=FILT.length;const pages=Math.ceil(total/PG_SIZE);PG=Math.min(PG,pages-1);PG=Math.max(PG,0);
  const start=PG*PG_SIZE;const slice=FILT.slice(start,start+PG_SIZE);
  document.getElementById('plt').innerHTML=buildTbl(slice,'none',start);
  document.getElementById('plc').textContent=`${start+1}‚Äì${Math.min(start+PG_SIZE,total)} of ${total.toLocaleString()}`;
  // Pagination nav
  const nav=document.getElementById('pgnav');
  if(pages<=1){nav.innerHTML='';return}
  let h=`<button class="btn-s" onclick="PG=0;renderPlayers()" ${PG===0?'disabled style="opacity:.3"':''}>¬´</button>`;
  h+=`<button class="btn-s" onclick="PG=Math.max(0,PG-1);renderPlayers()" ${PG===0?'disabled style="opacity:.3"':''}>‚Äπ</button>`;
  h+=`<span style="font-size:.65rem;color:var(--t2);padding:0 .3rem">${PG+1}/${pages}</span>`;
  h+=`<button class="btn-s" onclick="PG=Math.min(${pages-1},PG+1);renderPlayers()" ${PG>=pages-1?'disabled style="opacity:.3"':''}>‚Ä∫</button>`;
  h+=`<button class="btn-s" onclick="PG=${pages-1};renderPlayers()" ${PG>=pages-1?'disabled style="opacity:.3"':''}>¬ª</button>`;
  nav.innerHTML=h;
}
function renderPos(){const g=document.getElementById('pgd');g.style.cssText='display:grid;grid-template-columns:repeat(auto-fill,minmax(310px,1fr));gap:.7rem;margin-top:.7rem';
  g.innerHTML=['OH','MB','S','L/DS','OPP'].map(pos=>{const pp=[...FILT].filter(p=>p._np===pos).sort((a,b)=>b._score-a._score).slice(0,10);return `<div style="background:var(--sf);border:1px solid var(--bd);border-radius:12px;overflow:hidden"><div style="padding:.6rem .8rem;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between"><h4 style="font-size:.8rem;font-weight:600">${pbH(pos)} ${PN[pos]}</h4><span style="font-size:.62rem;color:var(--t3)">${FILT.filter(p=>p._np===pos).length}</span></div><div style="padding:.15rem 0">${pp.map((p,i)=>`<div style="display:flex;align-items:center;padding:.35rem .8rem;gap:.5rem;cursor:pointer;transition:background .1s" onmouseover="this.style.background='var(--s2)'" onmouseout="this.style.background=''" onclick="openP(${p._id})"><span class="mono" style="font-size:.62rem;color:var(--t3);min-width:16px">${i+1}</span><div style="flex:1;min-width:0;overflow:hidden"><div style="font-weight:600;font-size:.75rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.Player}</div><div style="font-size:.6rem;color:var(--t3)">${p.Team} ¬∑ ${p._score}</div></div><span class="mono" style="font-size:.7rem;font-weight:700;color:var(--gn)">$${p._val.toLocaleString()}</span></div>`).join('')}</div></div>`}).join('')}

// PLAYER MODAL
function openP(id){const p=ALL.find(x=>x._id===id);if(!p)return;const stats=gSP(p,PCT);const sorted=Object.entries(stats).sort((a,b)=>b[1].pctile-a[1].pctile);const str=sorted.filter(([k,v])=>v.pctile>=70&&v.weight>0).slice(0,5);const wk=sorted.filter(([k,v])=>v.pctile<=35&&v.weight>0).slice(0,4);
  const setsThresh=ALL.length?quantile(ALL.map(x=>x.Sets),VS.setsPctile):100;const adjFactor=VS.setsAdj==='on'?Math.sqrt(Math.min(1,(p.Sets||1)/setsThresh)):1;
  const hist=HIST[p.Player]||[];const prevTeams=[...new Set(hist.filter(h=>h.Season!==2025&&h.Team!==p.Team).map(h=>h.Team))];const yearsActive=hist.length>1?`${hist[0].Season}‚Äì2025`:'2025';
  document.getElementById('mh').innerHTML=`<div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.4rem">${pbH(p._np)} ${tbH(p._tier)}${hist.length>1?` <span style="font-size:.6rem;color:var(--t3);background:var(--s2);padding:.12rem .35rem;border-radius:4px">${yearsActive} ¬∑ ${hist.length} seasons</span>`:''}</div><div style="font-size:1.3rem;font-weight:700">${p.Player}</div><div style="color:var(--t2);font-size:.8rem">${p.Team}${prevTeams.length?' <span style="color:var(--cy);font-size:.68rem">(prev: '+prevTeams.join(', ')+')</span>':''}  ¬∑ ${PN[p._np]} ¬∑ ${p.Sets} sets / ${p.Matches} matches${VS.setsAdj==='on'?` ¬∑ Sets adj: ${(adjFactor*100).toFixed(0)}%`:''}</div><div style="margin-top:.4rem;display:flex;flex-wrap:wrap;gap:.2rem">${tagHH(p._tags,true)}</div>`;
  document.getElementById('mb').innerHTML=`<div class="pgrid">
    <div class="psec" style="text-align:center"><h4>Score</h4><div class="mono" style="font-size:2.5rem;font-weight:700;color:${p._score>=82?'var(--yw)':p._score>=65?'var(--gn)':p._score>=45?'var(--bl)':'var(--pu)'}">${p._score}</div><div style="font-size:.7rem;color:var(--t2)">/ 100</div><div class="mono" style="margin-top:.5rem;font-size:1.3rem;font-weight:700;color:var(--gn)">$${p._val.toLocaleString()}</div><div style="font-size:.6rem;color:var(--t3)">Predicted Value</div></div>
    <div class="psec"><h4>Raw Stats</h4><table style="width:100%;font-size:.72rem">${[['Kills',p.Kills,p._kps+'/s'],['Hit %',(p['Hit %']||0).toFixed(3)],['Digs',p.Digs,p._dps+'/s'],['Assists',p.Assists,p._aps+'/s'],['Blocks',p['Total Blk'],p._bps+'/s'],['Aces',p.Aces,p._acps+'/s'],['Points',p.PTS,p._pps+'/s'],['Atk Err',p['Atk Err'],((p['Atk Err']||0)/Math.max(p.Atk||1,1)*100).toFixed(1)+'%'],['Serv Err',p['Serv Err']],['BH Err',p['BH Err']]].map(([l,v,sub])=>`<tr><td style="color:var(--t2);padding:.18rem 0">${l}</td><td style="text-align:right" class="mono">${v}${sub?` <span style="color:var(--t3);font-size:.58rem">${sub}</span>`:''}</td></tr>`).join('')}</table></div>
    <div class="psec full"><h4>Percentile Breakdown <span style="font-size:.6rem;font-weight:400;color:var(--t3)">vs ${p._np} ‚Äî click stat for info</span></h4><div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.3rem">${Object.entries(stats).map(([st,v])=>{let c='var(--t3)';if(v.pctile>=80)c='var(--yw)';else if(v.pctile>=60)c='var(--gn)';else if(v.pctile>=40)c='var(--bl)';else if(v.pctile>=20)c='var(--pu)';else c='var(--rd)';return `<div style="flex:1;min-width:68px;text-align:center;cursor:pointer" onclick="event.stopPropagation();showSTT(this,'${st}')"><div style="font-size:.55rem;color:var(--t3);text-transform:uppercase;margin-bottom:.15rem">${SI[st]?.n||st}</div><div style="height:4px;background:var(--s3);border-radius:2px;overflow:hidden;margin-bottom:.12rem"><div style="height:100%;border-radius:2px;width:${v.pctile}%;background:${c}"></div></div><div class="mono" style="font-size:.68rem;font-weight:700;color:${c}">${v.pctile}%</div></div>`}).join('')}</div></div>
    <div class="psec"><h4>üí™ Strengths</h4>${str.length?str.map(([st,v])=>`<div style="display:flex;align-items:center;gap:.3rem;font-size:.75rem;padding:.15rem 0"><span style="color:var(--gn)">‚ñ≤</span>${SI[st]?.n||st}: <b style="color:var(--gn)">${v.pctile}th</b></div>`).join(''):'<div style="color:var(--t3);font-size:.75rem">None</div>'}</div>
    <div class="psec"><h4>‚ö†Ô∏è Weaknesses</h4>${wk.length?wk.map(([st,v])=>`<div style="display:flex;align-items:center;gap:.3rem;font-size:.75rem;padding:.15rem 0"><span style="color:var(--rd)">‚ñº</span>${SI[st]?.n||st}: <b style="color:var(--rd)">${v.pctile}th</b></div>`).join(''):'<div style="color:var(--t3);font-size:.75rem">None</div>'}</div>
    <div class="psec full"><h4>üìÖ Career History</h4>${(()=>{
      const hist=HIST[p.Player];
      if(!hist||hist.length<=1) return '<div style="color:var(--t3);font-size:.75rem">No prior season data available.</div>';
      // Build per-set rates for each season
      const seasons=hist.map(h=>{const s=Math.max(h.Sets||1,1);return{yr:h.Season,team:h.Team,pos:h.Pos||h._np,sets:h.Sets,matches:h.Matches,kps:((h.Kills||0)/s),hp:h['Hit %']||0,dps:((h.Digs||0)/s),aps:((h.Assists||0)/s),bps:((h['Total Blk']||0)/s),acps:((h.Aces||0)/s),pps:((h.PTS||0)/s),kills:h.Kills||0,digs:h.Digs||0,assists:h.Assists||0,pts:h.PTS||0,current:h.Season===2025}});
      const cur=seasons.find(s=>s.current);const prev=seasons.filter(s=>!s.current);
      // Trend arrows
      function trend(cur,prev){if(!prev)return'';const diff=cur-prev;if(Math.abs(diff)<0.01)return' <span style="color:var(--t3)">‚Äî</span>';return diff>0?' <span style="color:var(--gn)">‚ñ≤</span>':' <span style="color:var(--rd)">‚ñº</span>'}
      const lastPrev=prev.length?prev[prev.length-1]:null;
      return `<div style="overflow-x:auto"><table style="width:100%;font-size:.7rem;border-collapse:collapse">
        <thead><tr><th style="text-align:left;padding:.3rem .4rem;border-bottom:1px solid var(--bd);font-size:.6rem;color:var(--t3)">Season</th><th style="text-align:left;padding:.3rem .4rem;border-bottom:1px solid var(--bd);font-size:.6rem;color:var(--t3)">Team</th><th style="text-align:left;padding:.3rem .4rem;border-bottom:1px solid var(--bd);font-size:.6rem;color:var(--t3)">Pos</th><th style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);font-size:.6rem;color:var(--t3);text-align:right">Sets</th><th style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);font-size:.6rem;color:var(--t3);text-align:right">K/S</th><th style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);font-size:.6rem;color:var(--t3);text-align:right">Hit%</th><th style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);font-size:.6rem;color:var(--t3);text-align:right">D/S</th><th style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);font-size:.6rem;color:var(--t3);text-align:right">A/S</th><th style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);font-size:.6rem;color:var(--t3);text-align:right">B/S</th><th style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);font-size:.6rem;color:var(--t3);text-align:right">Ace/S</th><th style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);font-size:.6rem;color:var(--t3);text-align:right">PTS/S</th></tr></thead>
        <tbody>${seasons.map((s,i)=>{const prevS=i>0?seasons[i-1]:null;const isCur=s.current;return `<tr style="${isCur?'background:var(--ad);font-weight:600':'cursor:pointer'};transition:background .1s" ${!isCur?`onmouseover="this.style.background='var(--s2)'" onmouseout="this.style.background=''" onclick="openHist('${p.Player.replace(/'/g,"\\'")}',${s.yr})"`:''} title="${isCur?'Current season':'Click to view '+s.yr+' profile'}"><td style="padding:.3rem .4rem;border-bottom:1px solid var(--bd)">${s.yr}${isCur?' ‚òÖ':''}</td><td style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.team}${(prevS&&s.team!==prevS.team)?' <span style="color:var(--cy);font-size:.55rem">‚Üó transfer</span>':''}</td><td style="padding:.3rem .4rem;border-bottom:1px solid var(--bd)">${s.pos}</td><td class="mono" style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);text-align:right">${s.sets}</td><td class="mono" style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);text-align:right">${s.kps.toFixed(2)}${isCur&&lastPrev?trend(s.kps,lastPrev.kps):''}</td><td class="mono" style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);text-align:right">${s.hp.toFixed(3)}${isCur&&lastPrev?trend(s.hp,lastPrev.hp):''}</td><td class="mono" style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);text-align:right">${s.dps.toFixed(2)}${isCur&&lastPrev?trend(s.dps,lastPrev.dps):''}</td><td class="mono" style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);text-align:right">${s.aps.toFixed(2)}${isCur&&lastPrev?trend(s.aps,lastPrev.aps):''}</td><td class="mono" style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);text-align:right">${s.bps.toFixed(2)}${isCur&&lastPrev?trend(s.bps,lastPrev.bps):''}</td><td class="mono" style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);text-align:right">${s.acps.toFixed(2)}${isCur&&lastPrev?trend(s.acps,lastPrev.acps):''}</td><td class="mono" style="padding:.3rem .4rem;border-bottom:1px solid var(--bd);text-align:right">${s.pps.toFixed(2)}${isCur&&lastPrev?trend(s.pps,lastPrev.pps):''}</td></tr>`}).join('')}</tbody>
      </table></div>
      ${lastPrev&&cur?`<div style="margin-top:.5rem;font-size:.68rem;color:var(--t2)">Compared to ${lastPrev.yr}${lastPrev.team!==cur.team?' ('+lastPrev.team+')':''}: ${(()=>{const changes=[];const d=(n,l,c,p)=>{const diff=c-p;if(Math.abs(diff)>=0.01)changes.push({stat:n,diff,pct:p?((diff/Math.abs(p))*100).toFixed(0):0})};d('K/S','kps',cur.kps,lastPrev.kps);d('Hit%','hp',cur.hp,lastPrev.hp);d('D/S','dps',cur.dps,lastPrev.dps);d('A/S','aps',cur.aps,lastPrev.aps);d('B/S','bps',cur.bps,lastPrev.bps);d('PTS/S','pps',cur.pps,lastPrev.pps);return changes.length?changes.map(c=>`<span style="color:${c.diff>0?'var(--gn)':'var(--rd)'}"><b>${c.diff>0?'+':''}${c.diff.toFixed(2)}</b> ${c.stat}</span>`).join(' ¬∑ '):'No significant changes'})()}</div>`:''}`
    })()}</div>
    <div class="psec full"><h4>üîÑ Similar Players</h4><div style="display:flex;gap:.35rem;flex-wrap:wrap">${ALL.filter(x=>x._np===p._np&&x._id!==p._id&&Math.abs(x._score-p._score)<=8).sort((a,b)=>Math.abs(a._score-p._score)-Math.abs(b._score-p._score)).slice(0,6).map(x=>`<div style="background:var(--s2);border:1px solid var(--bd);border-radius:6px;padding:.35rem .55rem;cursor:pointer" onmouseover="this.style.borderColor='var(--ac)'" onmouseout="this.style.borderColor='var(--bd)'" onclick="openP(${x._id})"><div style="font-weight:600;font-size:.72rem">${x.Player}</div><div style="font-size:.58rem;color:var(--t3)">${x.Team} ¬∑ ${x._score} ¬∑ $${x._val.toLocaleString()}</div></div>`).join('')||'<span style="color:var(--t3);font-size:.72rem">None</span>'}</div></div>
  </div>`;
  document.getElementById('pm').classList.add('show');document.getElementById('pm').onclick=e=>{if(e.target===document.getElementById('pm'))closeM()}}
function closeM(){document.getElementById('pm').classList.remove('show')}

// Open historical season profile
function openHist(playerName,season){
  const hist=HIST[playerName];if(!hist)return;
  const h=hist.find(x=>x.Season===season);if(!h)return;
  // Build a temporary player object from historical data
  const p={...h,Player:playerName,_np:nP(h.Pos)};
  if(!W[p._np])return;
  // Score this historical season against current 2025 percentiles
  const m=gm(p);
  const stats={};
  for(const[st,cfg]of Object.entries(W[p._np])){
    const arr=PCT[`${p._np}_${st}`];if(!arr)continue;
    stats[st]={value:m[st]||0,pctile:Math.round(gPc(m[st]||0,arr,cfg.dir==='down')*100),weight:cfg.w,dir:cfg.dir};
  }
  const score=scoreP(p,PCT);const tier=gTier(score);const val=gVal({...p,_score:score});
  const tags=gTags({...p,_score:score});
  const sorted=Object.entries(stats).sort((a,b)=>b[1].pctile-a[1].pctile);
  const str=sorted.filter(([k,v])=>v.pctile>=70&&v.weight>0).slice(0,5);
  const wk=sorted.filter(([k,v])=>v.pctile<=35&&v.weight>0).slice(0,4);
  const s=Math.max(p.Sets||1,1);
  const kps=((p.Kills||0)/s).toFixed(2),dps=((p.Digs||0)/s).toFixed(2),aps=((p.Assists||0)/s).toFixed(2),bps=((p['Total Blk']||0)/s).toFixed(2),acps=((p.Aces||0)/s).toFixed(2),pps=((p.PTS||0)/s).toFixed(2);

  // Find 2025 entry for comparison
  const cur25=ALL.find(x=>x.Player===playerName);
  const compHTML=cur25?`<div class="psec full"><h4>üìä vs 2025 Season</h4><div style="display:flex;gap:.8rem;flex-wrap:wrap;font-size:.72rem">${[
    ['Score',score,cur25._score],['Value','$'+val.toLocaleString(),'$'+cur25._val.toLocaleString()],
    ['K/S',kps,cur25._kps],['Hit%',(p['Hit %']||0).toFixed(3),(cur25['Hit %']||0).toFixed(3)],
    ['D/S',dps,cur25._dps],['A/S',aps,cur25._aps],['B/S',bps,cur25._bps],['Ace/S',acps,cur25._acps]
  ].map(([label,old,now])=>{
    const nOld=parseFloat(String(old).replace(/[$,]/g,'')),nNow=parseFloat(String(now).replace(/[$,]/g,''));
    const diff=nNow-nOld;const better=diff>0;const neutral=Math.abs(diff)<0.01;
    return `<div style="background:var(--s2);border:1px solid var(--bd);border-radius:6px;padding:.4rem .6rem;min-width:80px;text-align:center"><div style="font-size:.55rem;color:var(--t3);text-transform:uppercase;margin-bottom:.15rem">${label}</div><div class="mono" style="font-size:.7rem;color:var(--t2)">${old}</div><div style="font-size:.55rem;margin-top:.1rem;color:var(--t3)">‚Üí</div><div class="mono" style="font-size:.7rem;font-weight:700;color:${neutral?'var(--t2)':better?'var(--gn)':'var(--rd)'}">${now} ${neutral?'':better?'‚ñ≤':'‚ñº'}</div></div>`
  }).join('')}</div></div>`:'';

  // Build the full history table for navigation
  const allSeasons=hist.map(x=>x.Season);

  document.getElementById('mh').innerHTML=`<div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.4rem">${pbH(p._np)} ${tbH(tier)} <span style="font-size:.62rem;color:var(--yw);background:var(--yd);padding:.12rem .4rem;border-radius:4px;font-weight:600">${season} Season</span>${cur25?` <button class="btn-s" onclick="openP(${cur25._id})" style="font-size:.58rem;padding:.15rem .4rem">‚Üí View 2025</button>`:''}</div><div style="font-size:1.3rem;font-weight:700">${playerName}</div><div style="color:var(--t2);font-size:.8rem">${h.Team} ¬∑ ${PN[p._np]||p.Pos} ¬∑ ${p.Sets} sets / ${p.Matches||'?'} matches</div><div style="margin-top:.4rem;display:flex;flex-wrap:wrap;gap:.2rem">${tagHH(tags,true)}${allSeasons.length>1?` <span style="font-size:.55rem;color:var(--t3);padding:.1rem .3rem">| Other seasons: ${allSeasons.filter(y=>y!==season).map(y=>`<span style="color:var(--cy);cursor:pointer;text-decoration:underline" onclick="openHist('${playerName.replace(/'/g,"\\'")}',${y})">${y}</span>`).join(' ')}</span>`:''}</div>`;

  document.getElementById('mb').innerHTML=`<div class="pgrid">
    <div class="psec" style="text-align:center"><h4>${season} Score <span style="font-size:.58rem;color:var(--t3);font-weight:400">scored vs 2025 peers</span></h4><div class="mono" style="font-size:2.5rem;font-weight:700;color:${score>=82?'var(--yw)':score>=65?'var(--gn)':score>=45?'var(--bl)':'var(--pu)'}">${score}</div><div style="font-size:.7rem;color:var(--t2)">/ 100</div><div class="mono" style="margin-top:.5rem;font-size:1.3rem;font-weight:700;color:var(--gn)">$${val.toLocaleString()}</div><div style="font-size:.6rem;color:var(--t3)">Projected Predicted Value</div></div>
    <div class="psec"><h4>${season} Raw Stats</h4><table style="width:100%;font-size:.72rem">${[['Kills',p.Kills||0,kps+'/s'],['Hit %',(p['Hit %']||0).toFixed(3)],['Digs',p.Digs||0,dps+'/s'],['Assists',p.Assists||0,aps+'/s'],['Blocks',p['Total Blk']||0,bps+'/s'],['Aces',p.Aces||0,acps+'/s'],['Points',p.PTS||0,pps+'/s'],['Atk Err',p['Atk Err']||0,((p['Atk Err']||0)/Math.max(p.Atk||1,1)*100).toFixed(1)+'%'],['Serv Err',p['Serv Err']||0],['BH Err',p['BH Err']||0]].map(([l,v,sub])=>`<tr><td style="color:var(--t2);padding:.18rem 0">${l}</td><td style="text-align:right" class="mono">${v}${sub?` <span style="color:var(--t3);font-size:.58rem">${sub}</span>`:''}</td></tr>`).join('')}</table></div>
    <div class="psec full"><h4>Percentile Breakdown <span style="font-size:.6rem;font-weight:400;color:var(--t3)">vs 2025 ${p._np} players</span></h4><div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.3rem">${Object.entries(stats).map(([st,v])=>{let c='var(--t3)';if(v.pctile>=80)c='var(--yw)';else if(v.pctile>=60)c='var(--gn)';else if(v.pctile>=40)c='var(--bl)';else if(v.pctile>=20)c='var(--pu)';else c='var(--rd)';return `<div style="flex:1;min-width:68px;text-align:center;cursor:pointer" onclick="event.stopPropagation();showSTT(this,'${st}')"><div style="font-size:.55rem;color:var(--t3);text-transform:uppercase;margin-bottom:.15rem">${SI[st]?.n||st}</div><div style="height:4px;background:var(--s3);border-radius:2px;overflow:hidden;margin-bottom:.12rem"><div style="height:100%;border-radius:2px;width:${v.pctile}%;background:${c}"></div></div><div class="mono" style="font-size:.68rem;font-weight:700;color:${c}">${v.pctile}%</div></div>`}).join('')}</div></div>
    <div class="psec"><h4>üí™ Strengths</h4>${str.length?str.map(([st,v])=>`<div style="display:flex;align-items:center;gap:.3rem;font-size:.75rem;padding:.15rem 0"><span style="color:var(--gn)">‚ñ≤</span>${SI[st]?.n||st}: <b style="color:var(--gn)">${v.pctile}th</b></div>`).join(''):'<div style="color:var(--t3);font-size:.75rem">None</div>'}</div>
    <div class="psec"><h4>‚ö†Ô∏è Weaknesses</h4>${wk.length?wk.map(([st,v])=>`<div style="display:flex;align-items:center;gap:.3rem;font-size:.75rem;padding:.15rem 0"><span style="color:var(--rd)">‚ñº</span>${SI[st]?.n||st}: <b style="color:var(--rd)">${v.pctile}th</b></div>`).join(''):'<div style="color:var(--t3);font-size:.75rem">None</div>'}</div>
    ${compHTML}
  </div>`;
  document.getElementById('pm').classList.add('show');document.getElementById('pm').onclick=e=>{if(e.target===document.getElementById('pm'))closeM()}}

// TOOLTIPS
function showTT(el,name){const tt=document.getElementById('ttp');const r=el.getBoundingClientRect();document.getElementById('ttt').textContent=name;document.getElementById('ttb').textContent=TI[name]||'No info.';tt.style.top=Math.min(r.bottom+6,window.innerHeight-180)+'px';tt.style.left=Math.min(r.left,window.innerWidth-320)+'px';tt.classList.add('show')}
function showSTT(el,st){const tt=document.getElementById('ttp');const r=el.getBoundingClientRect();const i=SI[st];document.getElementById('ttt').textContent=(i?.n||st)+(i?.dir==='down'?' (Lower = Better)':' (Higher = Better)');document.getElementById('ttb').textContent=i?.d||'No info.';tt.style.top=Math.min(r.bottom+6,window.innerHeight-180)+'px';tt.style.left=Math.min(r.left,window.innerWidth-320)+'px';tt.classList.add('show')}
function closeTT(){document.getElementById('ttp').classList.remove('show')}
document.addEventListener('click',e=>{if(!e.target.closest('.ttpop')&&!e.target.closest('.tag'))closeTT()})

// ROSTER
function addR(id){const p=ALL.find(x=>x._id===id);if(!p||ROST.some(r=>r._id===id))return;if(ROST.length>=RSIZE)return alert(`Roster full (${RSIZE}).`);ROST.push(p);renderAll()}
function rmR(id){ROST=ROST.filter(r=>r._id!==id);SWAPPED.delete(id);renderAll()}
function swpR(out,inn){ROST=ROST.filter(r=>r._id!==out);const p=ALL.find(x=>x._id===inn);if(p){ROST.push(p);SWAPPED.add(inn)}renderAll()}
function addAll(){const avail=FILT.filter(p=>!ROST.some(r=>r._id===p._id)).sort((a,b)=>b._score-a._score);for(const p of avail){if(ROST.length>=RSIZE)break;const spent=ROST.reduce((s,r)=>s+r._val,0);if(p._val<=TBUDGET-spent&&p._val<=PBUDGET)ROST.push(p)}renderAll()}
function clearR(){ROST=[];SWAPPED.clear();renderAll()}
let SWAPPED=new Set(); // Track players swapped in via recommendation ‚Äî they won't be suggested for further swaps

function renderRost(){
  const z=document.getElementById('rz');const spent=ROST.reduce((s,p)=>s+p._val,0);const rem=TBUDGET-spent;
  const pc={OH:0,MB:0,S:0,'L/DS':0,OPP:0};ROST.forEach(p=>pc[p._np]=(pc[p._np]||0)+1);
  const ideal={OH:3,MB:2,S:1,'L/DS':2,OPP:1};
  const cats={offense:{l:'Offense',i:'‚öîÔ∏è',s:['kills_per_set','hit_pct','pts_per_set']},defense:{l:'Defense',i:'üõ°Ô∏è',s:['digs_per_set']},blocking:{l:'Blocking',i:'üß±',s:['blk_per_set']},serving:{l:'Serving',i:'üéØ',s:['aces_per_set']},serv_ctrl:{l:'Serve Control',i:'üéõÔ∏è',s:['serv_err_rate']},setting:{l:'Setting',i:'ü§≤',s:['assists_per_set']},durability:{l:'Durability',i:'üí™',s:['consistency']},efficiency:{l:'Efficiency',i:'üìà',s:['hit_pct','atk_err_rate']}};
  const cs={};for(const[cat,info]of Object.entries(cats)){let tot=0,cnt=0;for(const p of ROST){const sp=gSP(p,PCT);for(const st of info.s){if(sp[st]){tot+=sp[st].pctile;cnt++}}}cs[cat]=cnt>0?Math.round(tot/cnt):50}
  function pc2(s){if(s>=75)return'var(--yw)';if(s>=60)return'var(--gn)';if(s>=45)return'var(--bl)';if(s>=30)return'var(--ac)';return'var(--rd)'}
  function pt(cat,s){if(s>=70)return{t:`Strong: ${cats[cat].l}`,c:'var(--gn)',bg:'var(--gd)'};if(s>=50)return{t:`Avg: ${cats[cat].l}`,c:'var(--bl)',bg:'var(--bld)'};return{t:`Weak: ${cats[cat].l}`,c:'var(--rd)',bg:'var(--rdd)'}}

  let alerts='';const pn=[],po=[];
  for(const[pos,need]of Object.entries(ideal))if((pc[pos]||0)<need)pn.push({pos,need,have:pc[pos]||0});
  for(const[pos,cnt]of Object.entries(pc))if(cnt>(ideal[pos]||0)+1)po.push({pos,cnt,ideal:ideal[pos]||0});
  if(po.length)alerts+=`<div class="alert alert-w"><h4>‚ö†Ô∏è Too many ${po.map(o=>`${o.pos} (${o.cnt}, typical ${o.ideal})`).join(', ')}</h4><p>Consider swapping for ${pn.length?pn.map(n=>n.pos).join('/'):' other positions'}.</p></div>`;
  if(pn.length&&ROST.length>=2)alerts+=`<div class="alert alert-i"><h4>üìã Need: ${pn.map(n=>`${n.need-n.have} ${n.pos}`).join(', ')}</h4></div>`;
  const weakest=ROST.length>=3?Object.entries(cs).sort((a,b)=>a[1]-b[1])[0]:null;
  if(weakest&&weakest[1]<45)alerts+=`<div class="alert alert-e"><h4>üìâ Weakest: ${cats[weakest[0]].l} (${weakest[1]}th)</h4><p>See swap suggestions below.</p></div>`;

  // Recs
  let recs='';
  if(pn.length&&ROST.length>=1){for(const need of pn.slice(0,2)){const cands=ALL.filter(p=>p._np===need.pos&&!ROST.some(r=>r._id===p._id)&&p._val<=rem&&p._val<=PBUDGET).sort((a,b)=>b._score-a._score).slice(0,3);if(cands.length)recs+=`<div style="margin-bottom:.5rem"><div style="font-size:.72rem;font-weight:600;color:var(--t2);margin-bottom:.2rem">Recommend ${need.pos} (${PN[need.pos]}):</div>${cands.map(p=>`<div class="rec" onclick="openP(${p._id})" style="cursor:pointer"><div class="ri"><div class="rn">${p.Player}</div><div class="rt">${p.Team} ¬∑ ${p._score}</div></div>${pbH(p._np)}<span class="vc">$${p._val.toLocaleString()}</span><button class="btn-ad" onclick="event.stopPropagation();addR(${p._id})">+ Add</button></div>`).join('')}</div>`}}

  // Swap recs ‚Äî ONLY for players significantly below team avg, skip already-swapped-in players, offer BOTH same-pos and cross-pos options
  let swaps='';
  if(ROST.length>=5){
    const teamAvg=ROST.reduce((s,p)=>s+p._score,0)/ROST.length;
    const swapThreshold=teamAvg*0.75;
    const weakPlayers=[...ROST].filter(p=>p._score<swapThreshold&&!SWAPPED.has(p._id)).sort((a,b)=>a._score-b._score).slice(0,2);
    
    for(const wp of weakPlayers){
      const budget=rem+wp._val;
      
      // Option A: Same-position upgrade (always offer)
      const samePosUp=ALL.filter(p=>p._np===wp._np&&!ROST.some(r=>r._id===p._id)&&p._score>wp._score&&p._val<=budget&&p._val<=PBUDGET)
        .sort((a,b)=>{const aD=a._score-wp._score,bD=b._score-wp._score;return(bD/Math.max(b._val-wp._val,1))-(aD/Math.max(a._val-wp._val,1))}).slice(0,2);
      
      // Option B: Cross-position ‚Äî find best alternative position to swap into
      // Priority: positions with formal gaps (pn), then any position where team has fewer than ideal
      let crossPosUp=[];
      let crossLabel='';
      const wpPosCount=pc[wp._np]||0;
      const wpPosIdeal=ideal[wp._np]||0;
      
      // Build list of positions worth swapping to (sorted by need)
      const altPositions=[];
      // First: positions with formal gaps
      for(const n of pn) altPositions.push({pos:n.pos,reason:`team needs ${n.need-n.have} more ${PN[n.pos]}`});
      // Second: if this player's position is overloaded, suggest any position at or below ideal count
      if(wpPosCount>wpPosIdeal&&!altPositions.length){
        for(const[pos,id] of Object.entries(ideal)){
          if(pos!==wp._np&&(pc[pos]||0)<=id) altPositions.push({pos,reason:`balance roster (${pos}: ${pc[pos]||0}/${id})`});
        }
      }
      
      if(altPositions.length){
        const best=altPositions[0];
        crossPosUp=ALL.filter(p=>p._np===best.pos&&!ROST.some(r=>r._id===p._id)&&p._val<=budget&&p._val<=PBUDGET)
          .sort((a,b)=>b._score-a._score).slice(0,2);
        crossLabel=`Switch to ${best.pos} instead (${best.reason})`;
      }
      
      if(samePosUp.length||crossPosUp.length){
        swaps+=`<div style="margin-bottom:.7rem;background:var(--sf);border:1px solid var(--bd);border-radius:10px;padding:.8rem"><div style="font-size:.75rem;font-weight:600;margin-bottom:.15rem">üîÑ ${wp.Player} <span style="color:var(--t3);font-weight:400">(${wp._np}, score ${wp._score} ‚Äî team avg ${Math.round(teamAvg)})</span></div>`;
        
        if(samePosUp.length){
          swaps+=`<div style="font-size:.65rem;color:var(--t2);margin:.35rem 0 .2rem">Same position upgrade (${wp._np}):</div>`;
          swaps+=samePosUp.map(p=>`<div class="rec"><div class="ri"><div class="rn">${p.Player}</div><div class="rt">${p.Team} ¬∑ ${p._score} (+${p._score-wp._score}) ¬∑ Œî$${(p._val-wp._val).toLocaleString()}</div></div>${pbH(p._np)}<span class="vc">$${p._val.toLocaleString()}</span><button class="btn-sw" onclick="event.stopPropagation();swpR(${wp._id},${p._id})">‚áÑ Swap</button></div>`).join('');
        }
        
        if(crossPosUp.length){
          swaps+=`<div style="font-size:.65rem;color:var(--cy);margin:.35rem 0 .2rem">üí° ${crossLabel}:</div>`;
          swaps+=crossPosUp.map(p=>`<div class="rec"><div class="ri"><div class="rn">${p.Player}</div><div class="rt">${p.Team} ¬∑ ${p._score} ¬∑ Œî$${(p._val-wp._val).toLocaleString()}</div></div>${pbH(p._np)}<span class="vc">$${p._val.toLocaleString()}</span><button class="btn-sw" onclick="event.stopPropagation();swpR(${wp._id},${p._id})">‚áÑ Swap</button></div>`).join('');
        }
        
        swaps+=`</div>`;
      }
    }
    if(!weakPlayers.length&&ROST.length>=5)swaps=`<div style="font-size:.75rem;color:var(--t2);padding:.5rem 0">‚úÖ All roster players are within acceptable range of team average ‚Äî no swaps recommended.</div>`;
  }

  z.innerHTML=`
    <div class="rcfg"><div class="cg"><label>Team Budget</label><input class="ninput" value="${TBUDGET}" onchange="TBUDGET=+this.value||250000;renderAll()"></div><div class="cg"><label>Max/Player</label><input class="ninput" value="${PBUDGET}" onchange="PBUDGET=+this.value||85000;renderAll()"></div><div class="cg"><label>Roster Size</label><input class="ninput" value="${RSIZE}" style="width:55px" onchange="RSIZE=+this.value||14;renderAll()"></div>
      <div style="display:flex;gap:.4rem;flex-wrap:wrap;align-items:center"><div class="pill" style="border-color:${rem>=0?'var(--gn)':'var(--rd)'}"><b style="color:${rem>=0?'var(--gn)':'var(--rd)'}">$${rem.toLocaleString()}</b> left</div><div class="pill"><b>$${spent.toLocaleString()}</b> spent</div><div class="pill"><b>${ROST.length}</b>/${RSIZE}</div></div>
      <div style="display:flex;gap:.3rem;margin-left:auto"><button class="btn-sel" onclick="addAll()">‚äï Select All Filtered</button><button class="btn-s" onclick="clearR()" style="border-color:var(--rd);color:var(--rd)">‚úï Clear Roster</button></div>
    </div>
    ${ROST.length>=3?`<div class="tprof"><h3>TEAM STAT PROFILE</h3>${Object.entries(cs).map(([cat,s])=>`<div class="tpr"><span class="tpi">${cats[cat].i}</span><span class="tpl">${cats[cat].l}</span><div class="tpb"><div class="tpf" style="width:${s}%;background:${pc2(s)}"></div></div><span class="tpv" style="color:${pc2(s)}">${s}th</span></div>`).join('')}<div class="tptags">${Object.entries(cs).map(([cat,s])=>{const t=pt(cat,s);return `<span class="tag" style="background:${t.bg};color:${t.c}">${t.t}</span>`}).join('')}</div></div>`:''}
    ${alerts}${recs?`<div style="margin-bottom:.6rem">${recs}</div>`:''}${swaps?`<div style="margin-bottom:.6rem">${swaps}</div>`:''}
    <div class="tw"><div class="thb"><h3>üèóÔ∏è Roster</h3><span class="cnt">${ROST.length} ¬∑ $${spent.toLocaleString()}</span></div>${ROST.length?ROST.map(p=>`<div style="display:flex;align-items:center;padding:.45rem .7rem;gap:.5rem;border-bottom:1px solid var(--bd)"><button style="background:var(--rdd);border:none;color:var(--rd);width:20px;height:20px;border-radius:5px;cursor:pointer;font-size:.65rem" onclick="rmR(${p._id})">‚úï</button><div style="flex:1;cursor:pointer" onclick="openP(${p._id})"><span class="pn" style="font-size:.75rem">${p.Player}</span> <span class="tn">${p.Team}</span></div>${pbH(p._np)} ${tbH(p._tier)} <span class="mono" style="font-size:.68rem;color:var(--t2)">${p._score}</span><span class="vc" style="min-width:62px;text-align:right">$${p._val.toLocaleString()}</span></div>`).join(''):'<div style="padding:2rem;text-align:center;color:var(--t3);font-size:.8rem">Add players from below or use "Select All Filtered" to bulk-add.</div>'}</div>
    <div class="tw" style="margin-top:.7rem"><div class="thb"><h3>Available Players</h3><span class="cnt" id="avc"></span></div><div class="tscr" id="avt"></div></div>`;
  const aff=FILT.filter(p=>p._val<=rem&&p._val<=PBUDGET&&!ROST.some(r=>r._id===p._id)).sort((a,b)=>b._score-a._score).slice(0,200);
  document.getElementById('avt').innerHTML=buildTbl(aff,'add');document.getElementById('avc').textContent=`${aff.length} within budget`}

// WEIGHT EDITOR
let WP='OH';
function renderW(){const z=document.getElementById('wz');const w=W[WP];const tot=Object.values(w).reduce((s,c)=>s+c.w,0);
  z.innerHTML=`<div class="wtp"><h3>Weights / Min / Max</h3><div class="wsub">Adjust per-position stat weights. Click stat names for explanation. Direction: ‚Üë higher better, ‚Üì lower better.</div>
    <div class="wtabs">${['OH','MB','S','L/DS','OPP'].map(p=>`<button class="wtab ${p===WP?'active':''}" onclick="WP='${p}';renderW()">${pbH(p)} ${PN[p]}</button>`).join('')}</div>
    <table class="wtt"><thead><tr><th>Stat</th><th>W</th><th>Min</th><th>Max</th><th>Dir</th></tr></thead><tbody>
    ${Object.entries(w).map(([st,cfg])=>`<tr style="${cfg.w>0?'':'opacity:.5'}"><td><span style="cursor:help;border-bottom:1px dotted var(--t3);color:var(--tx);font-weight:500" onclick="event.stopPropagation();showSTT(this,'${st}')">${SI[st]?.n||st}</span></td><td><input type="number" value="${cfg.w}" min="0" max="50" id="ww_${st}" onchange="W['${WP}']['${st}'].w=+this.value;updWT()"></td><td><input type="number" value="${cfg.min}" step="0.01" id="wn_${st}" onchange="W['${WP}']['${st}'].min=+this.value" style="width:50px"></td><td><input type="number" value="${cfg.max}" step="0.01" id="wx_${st}" onchange="W['${WP}']['${st}'].max=+this.value" style="width:50px"></td><td style="color:${cfg.dir==='up'?'var(--gn)':'var(--rd)'}"><span title="${cfg.dir==='up'?'Higher is better':'Lower is better'}" style="cursor:help">${cfg.dir==='up'?'‚Üë':'‚Üì'}</span></td></tr>`).join('')}
    </tbody></table>
    <div class="wft"><div class="wtot">Total: <b id="wts">${tot}</b>/100 &nbsp; Remaining: <b id="wtr" style="color:${100-tot===0?'var(--gn)':'var(--ac)'}">${100-tot}</b></div><div class="wbtns"><button class="btn-a" onclick="applyW()">Apply & Recalculate</button><button class="btn-r" onclick="resetW()">Reset</button></div></div></div>`}
function updWT(){const w=W[WP];let t=0;for(const st of Object.keys(w)){const el=document.getElementById('ww_'+st);if(el)t+=+el.value}document.getElementById('wts').textContent=t;const r=100-t;document.getElementById('wtr').textContent=r;document.getElementById('wtr').style.color=r===0?'var(--gn)':'var(--ac)'}
function applyW(){for(const st of Object.keys(W[WP])){const we=document.getElementById('ww_'+st),mn=document.getElementById('wn_'+st),mx=document.getElementById('wx_'+st);if(we)W[WP][st].w=+we.value;if(mn)W[WP][st].min=+mn.value;if(mx)W[WP][st].max=+mx.value}recalc()}
function resetW(){W=JSON.parse(JSON.stringify(DW));renderW();recalc()}

// VALUATION SETTINGS
function renderVS(){const z=document.getElementById('vz');
  z.innerHTML=`<div class="vsp"><h3>Valuation Settings <button class="btn-r" onclick="resetVS()" style="font-size:.62rem;padding:.2rem .5rem">Reset</button></h3>
    <div class="vsub">Editable. Controls how scores translate to dollar valuations.</div>
    <div class="vsg">
      <div class="vi"><label>Average Pay</label><input type="number" id="vs-avg" value="${VS.avgPay}" onchange="VS.avgPay=+this.value;recalc()"></div>
      <div class="vi"><label>Min Pay</label><input type="number" id="vs-min" value="${VS.minPay}" onchange="VS.minPay=+this.value;recalc()"></div>
      <div class="vi"><label>Max Pay</label><input type="number" id="vs-max" value="${VS.maxPay}" onchange="VS.maxPay=+this.value;recalc()"></div>
      <div class="vi"><label>Star Value ($)</label><input type="number" id="vs-star" value="${VS.starValue}" onchange="VS.starValue=+this.value;recalc()"></div>
      <div class="vi"><label>Star Percentile</label><input type="number" id="vs-spct" value="${VS.starPctile}" step="0.01" min="0.5" max="1" onchange="VS.starPctile=+this.value;recalc()"></div>
      <div class="vi"><label>Sets Adjust</label><select id="vs-sadj" onchange="VS.setsAdj=this.value;recalc()"><option value="on" ${VS.setsAdj==='on'?'selected':''}>On (‚àö(min(1, Sets/Sets_p)))</option><option value="off" ${VS.setsAdj==='off'?'selected':''}>Off</option></select></div>
      <div class="vi"><label>Sets Percentile (P)</label><input type="number" id="vs-sp" value="${VS.setsPctile}" step="0.01" min="0.5" max="1" onchange="VS.setsPctile=+this.value;recalc()"></div>
    </div>
    <div class="vsnote">
      <b>Sets Adjustment:</b> Players with fewer sets get a valuation penalty. Formula: <code style="background:var(--s3);padding:.1rem .3rem;border-radius:3px;font-size:.65rem">‚àö(min(1, playerSets / p${(VS.setsPctile*100).toFixed(0)}Sets))</code>. This prevents players with very few sets from being overvalued due to inflated per-set rates. At the current p${(VS.setsPctile*100).toFixed(0)} threshold (~${ALL.length?quantile(ALL.map(x=>x.Sets),VS.setsPctile):100} sets), a player with 50 sets would get ~${ALL.length?(Math.sqrt(Math.min(1,50/quantile(ALL.map(x=>x.Sets),VS.setsPctile)))*100).toFixed(0):'71'}% of their full valuation.<br><br>
      <b>Star Value:</b> Increasing this spreads valuations further apart at the top end ‚Äî higher star value = bigger gap between elite and average players, while average stays anchored near Average Pay.
    </div>
  </div>`}
function resetVS(){VS={...VS_DEF};renderVS();recalc()}

// METHODOLOGY
function renderMeth(){const g=document.getElementById('mz');g.style.cssText='display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:.7rem;margin-top:.7rem';let h='';
  // Position weight cards with explanation
  for(const[pos,w]of Object.entries(W)){const c=PC[pos];h+=`<div style="background:var(--sf);border:1px solid var(--bd);border-radius:11px;padding:1rem"><h4 style="font-size:.8rem;font-weight:600;margin-bottom:.4rem"><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:${c};margin-right:.3rem"></span>${pos} ‚Äî ${PN[pos]}</h4><table style="width:100%;font-size:.7rem">${Object.entries(w).map(([st,cfg])=>{const isDown=cfg.dir==='down';return `<tr><td style="color:${isDown?'var(--rd)':'var(--t2)'};padding:.15rem 0">${SI[st]?.n||st}${isDown?' ‚Üì':''}</td><td style="text-align:right" class="mono">${cfg.w}%</td></tr>`}).join('')}<tr style="border-top:1px solid var(--bd)"><td style="padding:.3rem 0;font-weight:600">Total</td><td style="text-align:right;font-weight:600" class="mono">${Object.values(w).reduce((s,c)=>s+c.w,0)}%</td></tr></table></div>`}
  // Why red ‚Üì stats
  h+=`<div style="background:var(--sf);border:1px solid var(--bd);border-radius:11px;padding:1rem"><h4 style="font-size:.8rem;font-weight:600;margin-bottom:.4rem"><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--rd);margin-right:.3rem"></span>Why Red ‚Üì Stats?</h4><p style="font-size:.72rem;color:var(--t2);line-height:1.5">Stats in <span style="color:var(--rd)">red with ‚Üì</span> are <b>penalty stats</b> ‚Äî for these, <b>lower is better</b>. The model inverts the percentile: a player with a LOW error rate gets a HIGH percentile score.<br><br>‚Ä¢ <b>Atk Err Rate ‚Üì</b> ‚Äî % of attacks that are errors. A player hitting .250 error rate is giving away 1 in 4 attacks as free points.<br>‚Ä¢ <b>Serv Err Rate ‚Üì</b> ‚Äî service errors per set. Free points gifted to opponents.<br>‚Ä¢ <b>BH Err Rate ‚Üì</b> (setters) ‚Äî ball handling errors. Disrupts the entire offense.<br><br>These stats are penalized proportionally ‚Äî the weight (e.g., 8%) represents how much it hurts the score. A player with a high error rate loses points from their total.</p></div>`;
  // Min/Max explanation
  h+=`<div style="background:var(--sf);border:1px solid var(--bd);border-radius:11px;padding:1rem"><h4 style="font-size:.8rem;font-weight:600;margin-bottom:.4rem"><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--bl);margin-right:.3rem"></span>Min / Max Values</h4><p style="font-size:.72rem;color:var(--t2);line-height:1.5">Min and Max values come from real 2025 NCAA D1 data:<br>‚Ä¢ <b>Min</b> = 10th percentile (what a below-average player does)<br>‚Ä¢ <b>Max</b> = 95th percentile (what an elite player does)<br><br>These define the realistic range for each stat at each position. For example, OH Kills/Set ranges from 0.43 (bench player) to 3.88 (elite scorer). Values outside this range still work but are capped at 0% or 100% percentile. Coaches can adjust these to change how the model evaluates outliers.</p></div>`;
  // Receiving proxy
  h+=`<div style="background:var(--sf);border:1px solid var(--bd);border-radius:11px;padding:1rem"><h4 style="font-size:.8rem;font-weight:600;margin-bottom:.4rem"><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--cy);margin-right:.3rem"></span>Receiving Proxy</h4><p style="font-size:.72rem;color:var(--t2);line-height:1.5">This dataset has no serve-receive stat, so <b>Digs/Set</b> is the proxy. Data analysis confirmed: BH Err has near-zero variance for liberos (avg 0.001/set), making composite formulas useless. The correlation between digs and BH errors is actually <i>positive</i> (more touches = more errors). Digs/Set is the strongest signal: 44% for L/DS, 17% for OH, 12% for OPP.</p></div>`;
  // How scoring works
  h+=`<div style="background:var(--sf);border:1px solid var(--bd);border-radius:11px;padding:1rem"><h4 style="font-size:.8rem;font-weight:600;margin-bottom:.4rem"><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--ac);margin-right:.3rem"></span>How Scoring Works</h4><p style="font-size:.72rem;color:var(--t2);line-height:1.5">1. <b>Normalize:</b> Raw stats ‚Üí per-set rates (e.g., 300 kills in 100 sets = 3.0 K/S)<br>2. <b>Percentile:</b> Compare against all players at the same position. 3.0 K/S might be 85th percentile for OH.<br>3. <b>Weight:</b> Multiply each percentile by position weight (e.g., 85% √ó 24% = 20.4 points)<br>4. <b>Sum:</b> Add all weighted percentiles ‚Üí score 0‚Äì100<br>5. <b>Valuation:</b> Apply exponential curve ($3K‚Äì$85K) with sets adjustment</p></div>`;
  // Sets adjustment
  h+=`<div style="background:var(--sf);border:1px solid var(--bd);border-radius:11px;padding:1rem"><h4 style="font-size:.8rem;font-weight:600;margin-bottom:.4rem"><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--yw);margin-right:.3rem"></span>Sets Adjustment</h4><p style="font-size:.72rem;color:var(--t2);line-height:1.5">Players with fewer sets get a valuation discount to prevent inflation. A player with 25 sets who averages 4.0 K/S looks amazing, but we can't trust that small sample like someone who sustained it over 110 sets.<br><br>Formula: <code style="background:var(--s3);padding:.1rem .2rem;border-radius:3px;font-size:.62rem">‚àö(min(1, sets / p90_sets))</code><br>At p90 ‚âà 112 sets: 50 sets ‚Üí 67% valuation, 80 sets ‚Üí 85%, 112+ ‚Üí 100%.</p></div>`;
  g.innerHTML=h}
</script>
</body>
</html>
